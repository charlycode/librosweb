<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>8.4. Acceso a los datos (Symfony 1.4, la guía definitiva)</title>
        <link href="../../css/main-fa23fb7.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-82842-2']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        <link rel="apple-touch-icon" type="image/png" href="../../apple-touch-icon.png" />
        <link rel="apple-touch-icon-precomposed" type="image/png" href="../../apple-touch-icon.png" />
        <meta name="apple-mobile-web-app-title" content="LibrosWeb" />

        <link rel="shortcut icon" type="image/png" href="../../favicon.png" />
        <meta name="site:version" content="fa23fb7" />
        <link rel="author" href="https://plus.google.com/u/0/107307901774377088868" />
        <link rel="prev" href="las_clases_del_modelo.html" />
        <link rel="next" href="conexiones_con_la_base_de_datos.html" />
        <link rel="start" href="../index.html" />
        <meta name="twitter:site" content="@librosweb" />
        <link rel="search" type="application/opensearchdescription+xml" href="http://librosweb.es/opensearch/documentation.xml" title="Libros y tutoriales de LibrosWeb.es" />
        <meta property="fb:page_id" content="437758756273955" />
        <meta property="fb:app_id" content="437758756273955" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="8.4. Acceso a los datos (Symfony 1.4, la guía definitiva)" />
        <meta property="og:image" content="http://www.gravatar.com/avatar/9f219b4dfaa677bfd0f47753c02d5126.png?s=200" />
        <meta name="msapplication-TileColor" content="#CC1414" />
        <meta name="application-name" content="LibrosWeb" />
        <meta name="msapplication-tooltip" content="Libros y tutoriales sobre HTML, CSS, JavaScript, PHP y otras tecnologías web." />
    </head>
    <body class="book_page symfony_1_4">
    <div id="container" class="container">
        <div id="header">
            <h1><a href="../../index.html" title="LibrosWeb.es">LibrosWeb</a></h1>
            <form action="/buscar"><input type="text" placeholder="buscar..." name="q"/></form>
        </div>
        <div id="content"><div class="row">
        <ul class="breadcrumbs span12">
  <li><a href="../../index.html">Inicio</a></li>
  <li><a href="../index.html">Symfony 1.4, la guía definitiva</a></li>
  <li><a href="../capitulo_8.html">Capítulo 8. El modelo (Doctrine)</a></li>
  <li class="current"><span>8.4.. Acceso a los datos</span></li>
</ul>

<div class="span9">
    <h1 id="acceso_a_los_datos"><span>8.4.</span> Acceso a los datos</h1>
    

<p>En Symfony, el acceso a los datos se realiza mediante objetos. Si se está acostumbrado al modelo relacional y a utilizar consultas SQL para acceder y modificar los datos, los métodos del modelo de objetos pueden parecer complicados. No obstante, una vez que se prueba el poder de la orientación a objetos para acceder a los datos, probablemente te gustará mucho más.</p>

<p>En primer lugar, hay que asegurarse de que se utiliza el mismo vocabulario. Aunque el modelo relacional y el modelo de objetos utilizan conceptos similares, cada uno tiene su propia nomenclatura:</p>

<div class="table" id="table_8_1">

    <table>
<thead>
<tr>
  <th>Relacional</th>
  <th>Orientado a objetos</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Tabla</td>
  <td>Clase</td>
</tr>
<tr>
  <td>Fila, registro</td>
  <td>Objeto</td>
</tr>
<tr>
  <td>Campo, columna</td>
  <td>Propiedad</td>
</tr>
</tbody>
</table>
</div>


<h3 id="obtener_el_valor_de_una_columna">8.4.1. Obtener el valor de una columna</h3>

<p>Cuando Symfony construye el modelo, crea una clase de objeto base para cada uno de los modelos definidos en <code>schema.yml</code>. Estas clases contienen inicialmente una serie de métodos <em>getters</em> y <em>setters</em> apropiados para cada tipo de columna. Estos métodos <code>new</code>, <code>getXXX()</code> y <code>setXXX()</code> permiten crear los objetos y acceder a sus propiedades, como se muestra en el listado 8-7.</p>

<p><strong>Listado 8-7 - Métodos generados en una clase objeto</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$articulo</span> <span class="sy0">=</span> <span class="kw2">new</span> Articulo<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">setTitulo</span><span class="br0">&#40;</span><span class="st_h">'Mi primer artículo'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">setContenido</span><span class="br0">&#40;</span><span class="st0">&quot;Este es mi primer artículo. <span class="es1">\n</span> Espero que te guste.&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="re0">$titulo</span>    <span class="sy0">=</span> <span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">getTitulo</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$contenido</span> <span class="sy0">=</span> <span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">getContenido</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> La clase objeto generada se llama <code>Articulo</code>, pero en la base de datos se almacena en una tabla llamada <code>blog_article</code>. Si no se hubiera definido la propiedad <code>tableName</code>, la tabla se habría llamado <code>articulo</code>. Los métodos <code>getXXX()</code> y <code>setXXX()</code> aplican la técnica <em>camelCase</em> al nombre e las columnas, por lo que el método <code>getTitulo()</code> obtiene el valor de la columna <code>titulo</code> y el método <code>getCodigoPostal()</code> obtendría el valor de una columna llamada <code>codigo_postal</code>.</p></div>

<p>Para establecer el valor de varios campos a la vez, se puede utilizar el método <code>fromArray()</code>, que incluyen todos los objetos clase, como se muestra en el listado 8-8.</p>

<p><strong>Listado 8-8 - El método <code>fromArray()</code> es un <em>setter</em> múltiple</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">fromArray</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
  <span class="st_h">'Titulo'</span>    <span class="sy0">=&gt;</span> <span class="st_h">'Mi primer artículo'</span><span class="sy0">,</span>
  <span class="st_h">'Contenido'</span> <span class="sy0">=&gt;</span> <span class="st_h">'Este es mi primer artículo. \n Espero que te guste.'</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<h3 id="obtener_los_registros_relacionados">8.4.2. Obtener los registros relacionados</h3>

<p>La columna <code>articulo_id</code> de la tabla <code>blog_comentario</code> define implícitamente una clave externa a la tabla <code>blog_articulo</code>. Cada comentario está relacionado con un artículo y un artículo puede tener muchos comentarios. Las clases generadas contienen 5 métodos que traducen esta relación a la forma orientada a objetos, de la siguiente manera:</p>

<ul>
<li><code>$comentario-&gt;getArticulo()</code>: para obtener el objeto <code>Articulo</code> relacionado</li>
<li><code>$comentario-&gt;getArticuloId()</code>: para obtener el <code>id</code> del objeto <code>Articulo</code> relacionado</li>
<li><code>$comentario-&gt;setArticulo($articulo)</code>: para definir el objeto <code>Articulo</code> relacionado</li>
<li><code>$comentario-&gt;setArticuloId($id)</code>: para definir el objeto <code>Articulo</code> relacionado a partir de un <code>id</code></li>
<li><code>$articulo-&gt;getComentarios()</code>: para obtener los objetos <code>Comentario</code> relacionados</li>
</ul>

<p>Los métodos <code>getArticuloId()</code> y <code>setArticuloId()</code> demuestran que se puede utilizar la columna <code>articulo_id</code> como una columna normal y que se pueden indicar las relaciones manualmente, pero esto no es muy interesante.  La ventaja de la forma orientada a objetos es mucho más evidente en los otros tres métodos. El listado 8-9 muestra cómo utilizar los <em>setters</em> generados.</p>

<p><strong>Listado 8-9 - Las claves externas se traducen en un <em>setter</em> especial</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$comentario</span> <span class="sy0">=</span> <span class="kw2">new</span> Comentario<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">setAutor</span><span class="br0">&#40;</span><span class="st_h">'Steve'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">setContenido</span><span class="br0">&#40;</span><span class="st_h">'¡Es el mejor artículo que he leído nunca!'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// Añadir este comentario al anterior objeto $articulo</span>
<span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">setArticulo</span><span class="br0">&#40;</span><span class="re0">$articulo</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// Sintaxis alternativa</span>
<span class="co1">// Solo es correcta cuando el objeto artículo ya </span>
<span class="co1">// ha sido guardado anteriormente en la base de datos</span>
<span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">setArticuloId</span><span class="br0">&#40;</span><span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">getId</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El listado 8-10 muestra como utilizar los <em>getters</em> generados automáticamente. También muestra como encadenar varias llamadas a métodos en los objetos del modelo.</p>

<p><strong>Listado 8-10 - Las claves externas se traducen en <em>getters</em> especiales</strong></p>

<div class="code php">
<pre class="php"><span class="co1">// Relación de &quot;muchos a uno&quot;</span>
<span class="kw1">echo</span> <span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">getArticulo</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getTitulo</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
 <span class="sy0">=&gt;</span> Mi primer artículo
<span class="kw1">echo</span> <span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">getArticulo</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getContenido</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
 <span class="sy0">=&gt;</span> Este es mi primer artículo<span class="sy0">.</span>
    Espero que te guste<span class="sy0">.</span>
&nbsp;
<span class="co1">// Relación &quot;uno a muchos&quot;</span>
<span class="re0">$comentarios</span> <span class="sy0">=</span> <span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">getComentarios</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El método <code>getArticulo()</code> devuelve un objeto de tipo <code>Articulo</code>, que permite utilizar el método accesor <code>getTitulo()</code>. Se trata de una alternativa mucho mejor que realizar la unión de las tablas manualmente, ya que esto último necesitaría varias líneas de código (empezando con la llamada al método <code>$comment-&gt;getArticuloId()</code>).</p>

<p>La variable <code>$comentarios</code> del listado 8-10 contiene un array de objetos de tipo <code>Comentario</code>. Se puede mostrar el primer comentario mediante <code>$comentarios[0]</code> o se puede recorrer la colección entera mediante <code>foreach ($comentarios as $comentario)</code>.</p>

<h3 id="guardar_y_borrar_datos">8.4.3. Guardar y borrar datos</h3>

<p>Al utilizar el constructor <code>new</code> se crea un nuevo objeto, pero no un registro en la tabla <code>blog_articulo</code>. Si se modifica el objeto, tampoco se reflejan esos cambios en la base de datos. Para guardar los datos en la base de datos, se debe invocar el método <code>save()</code> del objeto.</p>

<div class="code php">
<pre class="php"><span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El ORM de Symfony es lo bastante inteligente como para detectar las relaciones entre objetos, por lo que al guardar el objeto <code>$articulo</code> también se guarda el objeto <code>$comentario</code> relacionado. También detecta si ya existía el objeto en la base de datos, por lo que el método <code>save()</code> a veces se traduce a una sentencia <code>INSERT</code> de SQL y otras veces se traduce a una sentencia <code>UPDATE</code>. La clave primaria se establece de forma automática al llamar al método <code>save()</code>, por lo que después de guardado, se puede obtener la nueva clave primaria del objeto mediante <code>$articulo-&gt;getId()</code>.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> Para determinar si un objeto es completamente nuevo, puedes utilizar el método <code>isNew()</code>. Para detectar si un objeto ha sido modificado y por tanto se debe guardar en la base de datos, utiliza el método <code>isModified()</code>.</p></div>

<p>Si lees los comentarios que insertan los usuarios en tus artículos, puede que te desanimes un poco para seguir publicando cosas en Internet. Si además no captas la ironía de los comentarios, puedes borrarlos fácilmente con el método <code>delete()</code>, como se muestra en el listado 8-11.</p>

<p><strong>Listado 8-11 - Borrar registros de la base de datos mediante el método <code>delete()</code> del objeto relacionado</strong></p>

<div class="code php">
<pre class="php"><span class="kw1">foreach</span> <span class="br0">&#40;</span><span class="re0">$articulo</span><span class="sy0">-&gt;</span><span class="me1">getComentarios</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">as</span> <span class="re0">$comentario</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<h3 id="obtener_registros_mediante_la_clave_primaria">8.4.4. Obtener registros mediante la clave primaria</h3>

<p>Si se conoce la clave primaria de un registro concreto, puedes emplear el método <code>find()</code> de la clase tabla para obtener el objeto relacionado.</p>

<div class="code php">
<pre class="php"><span class="re0">$articulo</span> <span class="sy0">=</span> Doctrine_Core<span class="sy0">::</span><span class="me2">getTable</span><span class="br0">&#40;</span><span class="st_h">'Articulo'</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">&#40;</span><span class="nu0">7</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El archivo <code>schema.yml</code> define el campo <code>id</code> como clave primaria de la tabla <code>blog_articulo</code>, por lo que la sentencia anterior obtiene el artículo cuyo <code>id</code> sea igual a <code>7</code>. Como se ha utilizado una clave primaria, sólo se obtiene un registro; la variable <code>$articulo</code> contiene un objeto de tipo <code>Articulo</code>.</p>

<p>En algunos casos, la clave primaria está formada por más de una columna, por lo que el método <code>find()</code> permite indicar varios parámetros, uno para cada columna de la clave primaria.</p>

<h3 id="obtener_registros_mediante_doctrine_query">8.4.5. Obtener registros mediante Doctrine_Query</h3>

<p>Cuando se quiere obtener más de un registro, se debe utilizar el método <code>createQuery()</code> de la clase table correspondiente a los objetos que se quieren obtener. Por ejemplo, para obtener objetos de la clase <code>Articulo</code>, se llama al método <code>Doctrine_Core::getTable('Articulo')-&gt;createQuery()-&gt;execute()</code>.</p>

<p>El primer parámetro del método <code>execute()</code> es un array que contiene todos los valores que se utilizan para completar la consulta que se ejecuta.</p>

<p>Un metodo <code>Doctrine_Query</code> vacío devuelve todos los objetos de la clase. El código del listado 8-12 obtiene por ejemplo todos los artículos de la base de datos.</p>

<p><strong>Listado 8-12 - Obtener registros mediante <code>Doctrine_Query</code> con el método <code>createQuery()</code> (consulta vacía)</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$q</span> <span class="sy0">=</span> Doctrine_Core<span class="sy0">::</span><span class="me2">getTable</span><span class="br0">&#40;</span><span class="st_h">'Articulo'</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">createQuery</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$articulos</span> <span class="sy0">=</span> <span class="re0">$q</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El código anterior genera la siguiente consulta SQL:</p>

<div class="code sql">
<pre class="sql"><span class="kw1">SELECT</span> b<span class="sy0">.</span>id <span class="kw1">AS</span> b__id<span class="sy0">,</span> b<span class="sy0">.</span>titulo <span class="kw1">AS</span> b__titulo<span class="sy0">,</span> b<span class="sy0">.</span>contenido <span class="kw1">AS</span> b__contenido<span class="sy0">,</span> b<span class="sy0">.</span>created_at <span class="kw1">AS</span> b__created_at<span class="sy0">,</span> b<span class="sy0">.</span>updated_at <span class="kw1">AS</span> b__updated_at <span class="kw1">FROM</span> blog_articulo b</pre>
</div>

<div class="admonition sidebar"><p><strong class="title">Hidratación</strong> Invocar el método <code>-&gt;execute()</code> es mucho más potente que una simple consulta SQL. En primer lugar, el código SQL se optimiza para el tipo de base de datos que se utiliza. En segundo lugar, todos los valores pasados a <code>Doctrine_Query</code> se escapan antes de incluirlos en el código SQL, para evitar los problemas de <em>SQL injection</em>. En tercer lugar, el método devuelve un array de objetos y no un <em>result set</em>. El ORM crea y rellena de forma automática los objetos en función del <em>result set</em> de la base de datos. Este proceso se conoce con el nombre de <em>hidratación</em> o <em>hydrating</em>.</p></div>

<p>Para las selecciones más complejas de objetos, se necesitan equivalentes a las sentencias <code>WHERE</code>, <code>ORDER BY</code>, <code>GROUP BY</code> y demás de SQL. El objeto <code>Doctrine_Query</code> dispone de métodos y parámetros para indicar todas estas condiciones. Si quieres obtener por ejemplo todos los comentarios escritos por el usuario <code>Steve</code> ordenados por fecha, puedes utilizar un objeto <code>Doctrine_Query</code> como el del listado 8-13.</p>

<p><strong>Listado 8-13 - Obtener registros mediante <code>Doctrine_Query</code> con el método <code>createQuery()</code> (<code>Doctrine_Query</code> con condiciones)</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$q</span> <span class="sy0">=</span> Doctrine_Core<span class="sy0">::</span><span class="me2">getTable</span><span class="br0">&#40;</span><span class="st_h">'Comentario'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">createQuery</span><span class="br0">&#40;</span><span class="st_h">'c'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">where</span><span class="br0">&#40;</span><span class="st_h">'c.autor = ?'</span><span class="sy0">,</span> <span class="st_h">'Steve'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">orderBy</span><span class="br0">&#40;</span><span class="st_h">'c.created_at ASC'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$comentarios</span> <span class="sy0">=</span> <span class="re0">$q</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El código anterior genera la siguiente consulta SQL:</p>

<div class="code sql">
<pre class="sql"><span class="kw1">SELECT</span> b<span class="sy0">.</span>id <span class="kw1">AS</span> b__id<span class="sy0">,</span> b<span class="sy0">.</span>articulo_id <span class="kw1">AS</span> b__articulo_id<span class="sy0">,</span> b<span class="sy0">.</span>autor <span class="kw1">AS</span> b__autor<span class="sy0">,</span> b<span class="sy0">.</span>contenido <span class="kw1">AS</span> b__contenido<span class="sy0">,</span> b<span class="sy0">.</span>created_at <span class="kw1">AS</span> b__created_at<span class="sy0">,</span> b<span class="sy0">.</span>updated_at <span class="kw1">AS</span> b__updated_at <span class="kw1">FROM</span> blog_comentario b <span class="kw1">WHERE</span> <span class="br0">&#40;</span>b<span class="sy0">.</span>autor <span class="sy0">=</span> ?<span class="br0">&#41;</span> <span class="kw1">ORDER</span> <span class="kw1">BY</span> b<span class="sy0">.</span>created_at <span class="kw1">ASC</span></pre>
</div>

<p>La tabla 8-1 compara la sintaxis de SQL y del objeto <code>Doctrine_Query</code>.</p>

<p><strong>Tabla 8-1 - Sintaxis de SQL y del objeto <code>Doctrine_Query</code></strong></p>

<div class="table" id="table_8_2">

    <table>
<thead>
<tr>
  <th>SQL</th>
  <th>Doctrine_Query</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>WHERE columna = valor</code></td>
  <td><code>-&gt;where('columna = ?', 'valor');</code></td>
</tr>
<tr>
  <td><code>ORDER BY columna ASC</code></td>
  <td><code>-&gt;orderBy('columna ASC');</code></td>
</tr>
<tr>
  <td><code>ORDER BY columna DESC</code></td>
  <td><code>-&gt;addOrderBy('columna DESC');</code></td>
</tr>
<tr>
  <td><code>LIMIT limite</code></td>
  <td><code>-&gt;limit(limite)</code></td>
</tr>
<tr>
  <td><code>OFFSET desplazamiento</code></td>
  <td><code>-&gt;offset(desplazamiento)</code></td>
</tr>
<tr>
  <td><code>FROM tabla1 LEFT JOIN tabla2 ON tabla1.col1 = tabla2.col2</code></td>
  <td><code>-&gt;leftJoin('a.Modelo2 m')</code></td>
</tr>
<tr>
  <td><code>FROM tabla1 INNER JOIN tabla2 ON tabla1.col1 = tabla2.col2</code></td>
  <td><code>-&gt;innerJoin('a.Modelo2 m')</code></td>
</tr>
</tbody>
</table>
</div>


<p>El listado 8-14 muestra otro ejemplo del uso de <code>Doctrine_Query</code> con condiciones múltiples. En el ejemplo se obtienen todos los comentarios del usuario <code>Steve</code> en los artículos que contienen la palabra <code>enjoy</code> y además, ordenados por fecha.</p>

<p><strong>Listado 8-14 - Otro ejemplo para obtener registros mediante <code>Doctrine_Query</code> con el método <code>createQuery()</code> (<code>Doctrine_Query</code> con condiciones)</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$q</span> <span class="sy0">=</span> Doctrine_Core<span class="sy0">::</span><span class="me2">getTable</span><span class="br0">&#40;</span><span class="st_h">'Comentario'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">createQuery</span><span class="br0">&#40;</span><span class="st_h">'c'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">where</span><span class="br0">&#40;</span><span class="st_h">'c.autor = ?'</span><span class="sy0">,</span> <span class="st_h">'Steve'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">leftJoin</span><span class="br0">&#40;</span><span class="st_h">'c.Articulo a'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">andWhere</span><span class="br0">&#40;</span><span class="st_h">'a.contenido LIKE ?'</span><span class="sy0">,</span> <span class="st_h">'%enjoy%'</span><span class="br0">&#41;</span>
  <span class="sy0">-&gt;</span><span class="me1">orderBy</span><span class="br0">&#40;</span><span class="st_h">'c.created_at ASC'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$comentarios</span> <span class="sy0">=</span> <span class="re0">$q</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El código anterior genera la siguiente consulta SQL:</p>

<div class="code sql">
<pre class="sql"><span class="kw1">SELECT</span> b<span class="sy0">.</span>id <span class="kw1">AS</span> b__id<span class="sy0">,</span> b<span class="sy0">.</span>articulo_id <span class="kw1">AS</span> b__articulo_id<span class="sy0">,</span> b<span class="sy0">.</span>autor <span class="kw1">AS</span> b__autor<span class="sy0">,</span> b<span class="sy0">.</span>contenido <span class="kw1">AS</span> b__contenido<span class="sy0">,</span> b<span class="sy0">.</span>created_at <span class="kw1">AS</span> b__created_at<span class="sy0">,</span> b<span class="sy0">.</span>updated_at <span class="kw1">AS</span> b__updated_at<span class="sy0">,</span> b2<span class="sy0">.</span>id <span class="kw1">AS</span> b2__id<span class="sy0">,</span> b2<span class="sy0">.</span>titulo <span class="kw1">AS</span> b2__titulo<span class="sy0">,</span> b2<span class="sy0">.</span>contenido <span class="kw1">AS</span> b2__contenido<span class="sy0">,</span> b2<span class="sy0">.</span>created_at <span class="kw1">AS</span> b2__created_at<span class="sy0">,</span> b2<span class="sy0">.</span>updated_at <span class="kw1">AS</span> b2__updated_at <span class="kw1">FROM</span> blog_comentario b <span class="kw1">LEFT</span> <span class="kw1">JOIN</span> blog_articulo b2 <span class="kw1">ON</span> b<span class="sy0">.</span>articulo_id <span class="sy0">=</span> b2<span class="sy0">.</span>id <span class="kw1">WHERE</span> <span class="br0">&#40;</span>b<span class="sy0">.</span>autor <span class="sy0">=</span> ? <span class="kw1">AND</span> b2<span class="sy0">.</span>contenido <span class="kw1">LIKE</span> ?<span class="br0">&#41;</span> <span class="kw1">ORDER</span> <span class="kw1">BY</span> b<span class="sy0">.</span>created_at <span class="kw1">ASC</span></pre>
</div>

<p>De la misma forma que el lenguaje SQL es sencillo pero permite construir consultas muy complejas, el objeto <code>Doctrine_Query</code> permite manejar condiciones de cualquier nivel de complejidad. Sin embargo, como muchos programadores piensan primero en el código SQL y luego lo traducen a las condiciones de la lógica orientada a objetos, es difícil comprender bien el objeto <code>Doctrine_Query</code> cuando se utiliza las primeras veces. La mejor forma de aprender es mediante ejemplos y aplicaciones de prueba. El sitio web del proyecto Symfony está lleno de ejemplos de cómo construir objetos de tipo <code>Doctrine_Query</code> para todo tipo de situaciones.</p>

<p>Todas las instancias de <code>Doctrine_Query</code> disponen de un método <code>count()</code>, que simplemente cuenta el número de registros que satisfacen las condiciones de la consulta y devuelve ese número como un entero. Como no se devuelve ningún objeto, no se realiza el proceso de <em>hidratación</em> y por eso el método <code>count()</code> es mucho más rápido que <code>execute()</code>.</p>

<p>Las clases tabla también incluyen los métodos <code>findAll()</code>, <code>findBy*()</code> y <code>findOneBy*()</code>, que en realidad son atajos para crear instancias de <code>Doctrine_Query</code>, ejecutarlas y devolver sus resultados.</p>

<p>Por último, si sólo quieres obtener el primer objeto devuelto por la consulta, reemplaza el método <code>execute()</code> por <code>fetchOne()</code>. Esto es muy útil cuando se sabe que las condiciones de <code>Doctrine_Query</code> solo van a devolver un resultado, y la ventaja es que el método devuelve directamente un objeto en vez de un array de objetos.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> Si una consulta <code>execute()</code> devuelve un gran número de resultados, puede que solo quieras mostrar unos pocos en la plantilla. Symfony incluye una clase especial para paginar resultados llamada <code>sfDoctrinePager</code> y que realiza la paginación de forma automática.</p></div>

<h3 id="uso_de_consultas_con_codigo_sql">8.4.6. Uso de consultas con código SQL</h3>

<p>A veces, no es necesario obtener los objetos, sino que solo son necesarios algunos datos calculados por la base de datos. Por ejemplo, para obtener la fecha de creación de todos los artículos, no tiene sentido obtener todos los artículos y después recorrer el array de los resultados. En este caso es preferible obtener directamente el resultado, ya que se evita el proceso de <em>hydrating</em>.</p>

<p>Por otra parte, no deberían utilizarse instrucciones PHP de acceso a la base de datos, porque se perderían las ventajas de la abstracción de bases de datos. Lo que significa que se debe evitar el ORM (Doctrine) pero no la abstracción de bases de datos (PDO).</p>

<p>Para realizar consultas a la base de datos con PDO, es necesario realizar los siguientes pasos:</p>

<ol>
<li>Obtener la conexión con la base de datos.</li>
<li>Construir la consulta.</li>
<li>Crear una sentencia con esa consulta.</li>
<li>Iterar el <em>result set</em> que devuelve la ejecución de la sentencia.</li>
</ol>

<p>Aunque lo anterior puede parecer un galimatías, el código del listado 8-15 es mucho más explícito.</p>

<p><strong>Listado 8-15 - Consultas SQL personalizadas con PDO</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$conexion</span> <span class="sy0">=</span> Doctrine_Manager<span class="sy0">::</span><span class="me2">connection</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$consulta</span> <span class="sy0">=</span> <span class="st_h">'SELECT MAX(created_at) AS max FROM blog_articulo'</span><span class="sy0">;</span>
<span class="re0">$sentencia</span> <span class="sy0">=</span> <span class="re0">$conexion</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="re0">$consulta</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$sentencia</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$resultset</span> <span class="sy0">=</span> <span class="re0">$sentencia</span><span class="sy0">-&gt;</span><span class="me1">fetch</span><span class="br0">&#40;</span>PDO<span class="sy0">::</span><span class="me2">FETCH_OBJ</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$max</span> <span class="sy0">=</span> <span class="re0">$resultset</span><span class="sy0">-&gt;</span><span class="kw3">max</span><span class="sy0">;</span></pre>
</div>

<p>Al igual que sucede con las selecciones realizadas con Doctrine, las consultas con PDO son un poco complicadas de usar al principio. Los ejemplos de las aplicaciones existentes y de los tutoriales pueden ser útiles para descubrir la forma de hacerlas.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> Si estás tentado de saltarte todo lo anterior para acceder de forma directa a la base de datos, corres el riesgo de perder la seguridad y la abstracción proporcionadas por Doctrine. Aunque con Doctrine es más largo de escribir, te obliga a hacer uso de las buenas prácticas que garantizan el buen rendimiento, la portabilidad y la seguridad de tu aplicación. Esta recomendación es especialmente útil para las consultas que contienen parámetros cuyo origen no es confiable, como por ejemplo cualquier dato proporcionado por un usuario de tu sitio. Doctrine se encarga de escapar todos los datos para mantener la seguridad de la base de datos. Si accedes directamente a la base de datos, corres el riesgo de sufrir ataques de tipo <em>SQL-injection</em>.</p></div>

<h3 id="uso_de_columnas_especiales_de_fechas">8.4.7. Uso de columnas especiales de fechas</h3>

<p>Normalmente, cuando una tabla tiene una columna llamada <code>created_at</code>, se utiliza para almacenar un <em>timestamp</em> de la fecha de creación del registro. La misma idea se aplica a las columnas <code>updated_at</code>, cuyo valor se debe actualizar cada vez que se actualiza el propio registro.</p>

<p>La buena noticia es que Doctrine dispone de un <em>comportamiento</em> llamado <code>Timestampable</code> que se ocupa de actualizar su valor de forma automática. No es necesario establecer manualmente el valor de las columnas <code>created_at</code> y <code>updated_at</code>; se actualizan automáticamente, tal y como muestra el listado 8-16.</p>

<p><strong>Listado 8-16 - Las columnas <code>created_at</code> y <code>updated_at</code> se gestionan automáticamente</strong></p>

<div class="code php">
<pre class="php"><span class="re0">$comentario</span> <span class="sy0">=</span> <span class="kw2">new</span> Comentario<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">setAutor</span><span class="br0">&#40;</span><span class="st_h">'Steve'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// Muestra la fecha de creación</span>
<span class="kw1">echo</span> <span class="re0">$comentario</span><span class="sy0">-&gt;</span><span class="me1">getCreatedAt</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
 <span class="sy0">=&gt;</span> <span class="br0">&#91;</span>fecha de la operación INSERT de la base de datos<span class="br0">&#93;</span></pre>
</div>

<div class="admonition sidebar"><p><strong class="title">Refactorizando la capa de datos</strong> Cuando se desarrolla un proyecto con Symfony, normalmente se empieza escribiendo el código de la lógica de dominio en las acciones. Sin embargo, las consultas a la base de datos y la manipulación del modelo no se debería realizar en la capa del controlador. De forma que toda la lógica relacionada con los datos se debería colocar en la capa del modelo. Cada vez que se ejecuta el mismo código en más de un sitio de las acciones, se debería mover ese código al modelo. De esta forma las acciones se mantienen cortas y fáciles de leer.</p>

<p>Por ejemplo, imagina el caso de un blog que tiene que obtener los diez artículos más populares relacionados con una etiqueta determinada (que se pasa como parámetro). Este código no debería estar en la acción, sino en el modelo. De hecho, si se tiene que mostrar en la plantilla la lista de artículos, la acción debería ser similar a la siguiente:</p>

<div class="code php">
<pre class="php"><span class="kw2">public</span> <span class="kw2">function</span> executeMuestraArticulosPopularesParaEtiqueta<span class="br0">&#40;</span><span class="re0">$request</span><span class="br0">&#41;</span>
 <span class="br0">&#123;</span>
   <span class="re0">$etiqueta</span> <span class="sy0">=</span> Doctrine_Core<span class="sy0">::</span><span class="me2">getTable</span><span class="br0">&#40;</span><span class="st_h">'Etiqueta'</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">findOneByName</span><span class="br0">&#40;</span><span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">getParameter</span><span class="br0">&#40;</span><span class="st_h">'etiqueta'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
   <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">forward404Unless</span><span class="br0">&#40;</span><span class="re0">$etiqueta</span><span class="br0">&#41;</span><span class="sy0">;</span>
   <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">articulos</span> <span class="sy0">=</span> <span class="re0">$etiqueta</span><span class="sy0">-&gt;</span><span class="me1">getArticulosPopulares</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">;</span>
 <span class="br0">&#125;</span></pre>
</div>

<p>La acción crea un objeto de clase <code>Etiqueta</code> a partir del parámetro de la petición. Después, todo el código necesario para realizar la consulta a la base de datos se almacena en el método <code>getArticulosPopulares()</code> de esta clase. La acción es más fácil de leer y el código del modelo se puede reutilizar fácilmente en otra acción.</p>

<p>Mover el código a un lugar más apropiado es una de las técnicas de refactorización. Si se realiza habitualmente, el código resultante es más fácil de mantener y de entender por otros programadores. Una buena regla general sobre cuando refactorizar la capa de los datos es que el código de una acción raramente debería tener más de 10 líneas de código PHP.</p></div>



    <div class="navigation row">
            <a class="span4 prev" href="las_clases_del_modelo.html">&larr; Anterior <span>8.3. Las clases del modelo</span></a>
            
            <a class="span5 next" href="conexiones_con_la_base_de_datos.html">Siguiente &rarr; <span>8.5. Conexiones con la base de datos</span></a>
        </div>
</div>

<div class="span3 side">
<h3 class="underline"><span>Compartir</span></h3>
<ul class="share">
    <li><a class="twitter" id="share_twitter" href="#" title="Compartir este artículo en Twitter">tw</a></li>
    <li><a class="facebook" id="share_facebook" href="#" title="Compartir este artículo en Facebook">fb</a></li>
    <li><a class="google" id="share_google" href="#" title="Compartir este artículo en Google+">g+</a></li>
</ul>

<script type="text/javascript">
var title    = 'Acceso a los datos (Symfony 1.4, la guía definitiva%29';
var page_url = encodeURIComponent(window.location);
var options  = 'menubar=no,toolbar=no,resizable=yes,scrollbars=no,width=640,height=350';
var services = {
    share_twitter:  'https://twitter.com/share?text=' + title + '&lang=es&hashtags=librosweb',
    share_facebook: 'http://www.facebook.com/sharer.php?u=' + page_url + '&t=' + title,
    share_google:   'https://plus.google.com/share?url=' + page_url + '&hl=es'
};

for (var id in services) { // don't use services.keys() for compatibility reasons
    if (services.hasOwnProperty(id)) {
        document.getElementById(id).href = services[id];
        document.getElementById(id).onclick = function(a) {
            a = a || window.event;
            a = a.target || a.srcElement;
            _gaq.push(['_trackEvent', 'share', a.id.substr(6), 'Symfony 1.4, la guía definitiva : Acceso a los datos']);
            window.open(services[a.id], a.title, options);

            return false;
        };
    }
}
</script>

<h3 class="underline"><span>Indice de contenidos</span></h3>
<ul class="toc">
    <li class="level-1">
        <span>1</span> <a href="../capitulo_1.html"> Introducción a Symfony</a>
    </li>
    <li class="level-1">
        <span>2</span> <a href="../capitulo_2.html"> Explorando el interior de Symfony</a>
    </li>
    <li class="level-1">
        <span>3</span> <a href="../capitulo_3.html"> Ejecutar aplicaciones Symfony</a>
    </li>
    <li class="level-1">
        <span>4</span> <a href="../capitulo_4.html"> Introducción a la creación de páginas</a>
    </li>
    <li class="level-1">
        <span>5</span> <a href="../capitulo_5.html"> Configurar Symfony</a>
    </li>
    <li class="level-1">
        <span>6</span> <a href="../capitulo_6.html"> El Controlador</a>
    </li>
    <li class="level-1">
        <span>7</span> <a href="../capitulo_7.html"> La Vista</a>
    </li>
    <li class="level-1 ">
        <a href="../capitulo_8.html">
            <span>Capítulo 8.</span> El modelo (Doctrine)
        </a>
    </li>
    <li class="level-2 ">
        <a href="por_que_utilizar_un_orm_y_una_capa_de_abstraccion.html">
            <span>8.1.</span> ¿Por qué utilizar un ORM y una capa de abstracción?
        </a>
    </li>
    <li class="level-2 ">
        <a href="esquema_de_base_de_datos_de_symfony.html">
            <span>8.2.</span> Esquema de base de datos de Symfony
        </a>
    </li>
    <li class="level-2 ">
        <a href="las_clases_del_modelo.html">
            <span>8.3.</span> Las clases del modelo
        </a>
    </li>
    <li class="level-2 active">
        <a href="acceso_a_los_datos.html">
            <span>8.4.</span> Acceso a los datos
        </a>
    </li>
    <li class="level-2 ">
        <a href="conexiones_con_la_base_de_datos.html">
            <span>8.5.</span> Conexiones con la base de datos
        </a>
    </li>
    <li class="level-2 ">
        <a href="extender_el_modelo.html">
            <span>8.6.</span> Extender el modelo
        </a>
    </li>
    <li class="level-2 ">
        <a href="sintaxis_extendida_del_esquema.html">
            <span>8.7.</span> Sintaxis extendida del esquema
        </a>
    </li>
    <li class="level-2 ">
        <a href="no_crees_el_modelo_dos_veces.html">
            <span>8.8.</span> No crees el modelo dos veces
        </a>
    </li>
    <li class="level-2 ">
        <a href="resumen.html">
            <span>8.9.</span> Resumen
        </a>
    </li>
    <li class="level-1">
        <span>9</span> <a href="../capitulo_9.html"> Enlaces y sistema de enrutamiento</a>
    </li>
    <li class="level-1">
        <span>10</span> <a href="../capitulo_10.html"> Formularios</a>
    </li>
    <li class="level-1">
        <span>11</span> <a href="../capitulo_11.html"> Emails</a>
    </li>
    <li class="level-1">
        <span>12</span> <a href="../capitulo_12.html"> Uso de la cache</a>
    </li>
    <li class="level-1">
        <span>13</span> <a href="../capitulo_13.html"> Internacionalización y localización</a>
    </li>
    <li class="level-1">
        <span>14</span> <a href="../capitulo_14.html"> Generador de la parte de administración</a>
    </li>
    <li class="level-1">
        <span>15</span> <a href="../capitulo_15.html"> Pruebas unitarias y funcionales</a>
    </li>
    <li class="level-1">
        <span>16</span> <a href="../capitulo_16.html"> Herramientas para la administración de aplicaciones</a>
    </li>
    <li class="level-1">
        <span>17</span> <a href="../capitulo_17.html"> Personalizar Symfony</a>
    </li>
    <li class="level-1">
        <span>18</span> <a href="../capitulo_18.html"> Rendimiento</a>
    </li>
    <li class="level-1">
        <span>19</span> <a href="../capitulo_19.html"> Configuración avanzada</a>
    </li>
</ul>
</div>
        </div></div>
        <div id="footer" class="row">
            <span class="span6">&copy; 2013 LibrosWeb.es 
            <a href="../../contacto/index.html">Contacto</a></span>
            <span class="span6 version">2.340 días online</span>
        </div>
    </div>
    </body>
</html>

<!-- Localized -->