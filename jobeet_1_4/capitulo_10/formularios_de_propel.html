<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>10.3. Formularios de Propel (El tutorial Jobeet)</title>
        <link href="../../css/main-fa23fb7.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-82842-2']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        <link rel="apple-touch-icon" type="image/png" href="../../apple-touch-icon.png" />
        <link rel="apple-touch-icon-precomposed" type="image/png" href="../../apple-touch-icon.png" />
        <meta name="apple-mobile-web-app-title" content="LibrosWeb" />

        <link rel="shortcut icon" type="image/png" href="../../favicon.png" />
        <meta name="site:version" content="fa23fb7" />
        <link rel="author" href="https://plus.google.com/u/0/107307901774377088868" />
        <link rel="prev" href="formularios.html" />
        <link rel="next" href="la_pagina_de_previsualizacion.html" />
        <link rel="start" href="../index.html" />
        <meta name="twitter:site" content="@librosweb" />
        <link rel="search" type="application/opensearchdescription+xml" href="http://librosweb.es/opensearch/documentation.xml" title="Libros y tutoriales de LibrosWeb.es" />
        <meta property="fb:page_id" content="437758756273955" />
        <meta property="fb:app_id" content="437758756273955" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="10.3. Formularios de Propel (El tutorial Jobeet)" />
        <meta property="og:image" content="http://www.gravatar.com/avatar/9f219b4dfaa677bfd0f47753c02d5126.png?s=200" />
        <meta name="msapplication-TileColor" content="#CC1414" />
        <meta name="application-name" content="LibrosWeb" />
        <meta name="msapplication-tooltip" content="Libros y tutoriales sobre HTML, CSS, JavaScript, PHP y otras tecnologías web." />
    </head>
    <body class="book_page jobeet_1_4">
    <div id="container" class="container">
        <div id="header">
            <h1><a href="../../index.html" title="LibrosWeb.es">LibrosWeb</a></h1>
            <form action="/buscar"><input type="text" placeholder="buscar..." name="q"/></form>
        </div>
        <div id="content"><div class="row">
        <ul class="breadcrumbs span12">
  <li><a href="../../index.html">Inicio</a></li>
  <li><a href="../index.html">El tutorial Jobeet</a></li>
  <li><a href="../capitulo_10.html">Capítulo 10. Los formularios</a></li>
  <li class="current"><span>10.3.. Formularios de Propel</span></li>
</ul>

<div class="span9">
    <h1 id="formularios_de_propel"><span>10.3.</span> Formularios de Propel</h1>
    

<p>Normalmente, los valores enviados con el formulario se guardan o serializan en una base de datos. Como Symfony ya dispone de toda la información sobre el modelo de tu base de datos, es capaz de generar automáticamente los formularios a partir de esa información. De hecho, cuando ejecutábamos la tarea <code>propel:build-all</code> durante el tutorial del día 3, Symfony ejecutaba internamente la tarea <code>propel:build-forms</code>:</p>

<div class="code cli">
<pre class="cli">$ php symfony propel:build-forms</pre>
</div>

<p>Los formularios que genera la tarea <code>propel:build-forms</code> se guardan en el directorio <code>lib/form/</code>. La forma en la que se organizan estos archivos generados automáticamente es similar a la del directorio <code>lib/model/</code>. Cada clase del modelo dispone de una clase de formulario (la clase <code>JobeetJob</code> dispone por ejemplo de <code>JobeetJobForm</code>). Inicialmente estas clases de formulario están vacías, ya que heredan de una clase base de formularios:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/form/JobeetJobForm.class.php</span>
<span class="kw2">class</span> JobeetJobForm <span class="kw2">extends</span> BaseJobeetJobForm
<span class="br0">&#123;</span>
  <span class="kw2">public</span> <span class="kw2">function</span> configure<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si echas un vistazo a los archivos generados automáticamente en el subdirectorio <code>lib/form/base/</code>, verás muchos buenos ejemplos de cómo utilizar los widgets y validadores incluidos en Symfony.</p></div>

<h3 id="personalizando_el_formulario_de_las_ofertas_de_trabajo">10.3.1. Personalizando el formulario de las ofertas de trabajo</h3>

<p>El formulario de las ofertas de trabajo es un buen ejemplo para aprender a personalizar los formularios. A continuación se muestran todos los pasos necesarios para personalizar este formulario.</p>

<p>En primer lugar, modifica el enlace <em>Post a Job</em> del layout para que puedas probar las modificaciones directamente en el navegador:</p>

<div class="code php">
<pre class="php">&lt;!-- apps/frontend/templates/layout.php --&gt;
&lt;a href=&quot;<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> url_for<span class="br0">&#40;</span><span class="st_h">'@job_new'</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>&quot;&gt;Post a Job&lt;/a&gt;</pre>
</div>

<p>Por defecto los formularios de Propel muestran campos para todas las columnas de la tabla. No obstante, en el formulario para insertar una oferta de trabajo, algunos campos no deben ser editables por los usuarios. Eliminar campos en un formulario es tan sencillo como utilizar la función <code>unset()</code> de PHP:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/form/JobeetJobForm.class.php</span>
<span class="kw2">class</span> JobeetJobForm <span class="kw2">extends</span> BaseJobeetJobForm
<span class="br0">&#123;</span>
  <span class="kw2">public</span> <span class="kw2">function</span> configure<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw3">unset</span><span class="br0">&#40;</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'created_at'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'updated_at'</span><span class="br0">&#93;</span><span class="sy0">,</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'expires_at'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'is_activated'</span><span class="br0">&#93;</span>
    <span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Eliminar un campo de formulario significa que se eliminan tanto su widget como su validador.</p>

<p>Normalmente, la configuración del formulario debe ser más precisa de lo que se puede determinar a partir del esquema de la base de datos. La columna <code>email</code> por ejemplo es un campo de tipo <code>varchar</code> en el esquema, pero necesitamos que sea validado como si fuera un email. Para ello, modifica el validador <code>sfValidatorString</code> por <code>sfValidatorEmail</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/form/JobeetJobForm.class.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> configure<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">// ...</span>
&nbsp;
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'email'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorEmail<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Sustituir el valor por defecto no siempre es la mejor opción, ya que se pierden las reglas de validación obtenidas a partir del esquema de la base de datos (<code>new sfValidatorString(array('max_length' =&gt; 255))</code>). Casi siempre es mejor añadir un nuevo validador a los ya existentes, utilizando para ello el validador especial <code>sfValidatorAnd</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/form/JobeetJobForm.class.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> configure<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">// ...</span>
&nbsp;
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'email'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorAnd<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'email'</span><span class="br0">&#93;</span><span class="sy0">,</span>
    <span class="kw2">new</span> sfValidatorEmail<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span>
  <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>El validador <code>sfValidatorAnd</code> toma como argumento un array de validadores que el valor debe pasar satisfactoriamente para considerarse válido. El truco consiste en utilizar el validador ya existente (<code>$this-&gt;validatorSchema['email']</code>) y después añadir el nuevo validador.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> Existe otro validador especial llamado <code>sfValidatorOr</code> que se emplea cuando es suficiente con que el valor pase satisfactoriamente al menos uno de los validadores indicados. También es posible combinar los validadores <code>sfValidatorAnd</code> y <code>sfValidatorOr</code> para crear validaciones muy complejas.</p></div>

<p>Por su parte, aunque la columna <code>type</code> también es de tipo <code>varchar</code> en el esquema de datos, queremos restringir su valor a uno de los tres siguientes valores: <em>full time</em> (jornada completa), <em>part time</em> (jornada parcial) y <em>freelance</em>.</p>

<p>En primer lugar, define los posibles valores en la clase <code>JobeetJobPeer</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/model/JobeetJobPeer.php</span>
<span class="kw2">class</span> JobeetJobPeer <span class="kw2">extends</span> BaseJobeetJobPeer
<span class="br0">&#123;</span>
  static <span class="kw2">public</span> <span class="re0">$types</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span>
    <span class="st_h">'full-time'</span> <span class="sy0">=&gt;</span> <span class="st_h">'Full time'</span><span class="sy0">,</span>
    <span class="st_h">'part-time'</span> <span class="sy0">=&gt;</span> <span class="st_h">'Part time'</span><span class="sy0">,</span>
    <span class="st_h">'freelance'</span> <span class="sy0">=&gt;</span> <span class="st_h">'Freelance'</span><span class="sy0">,</span>
  <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
  <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre>
</div>

<p>A continuación, utiliza el widget <code>sfWidgetFormChoice</code> para el campo <code>type</code>:</p>

<div class="code php">
<pre class="php"><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="br0">&#91;</span><span class="st_h">'type'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfWidgetFormChoice<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
  <span class="st_h">'choices'</span>  <span class="sy0">=&gt;</span> JobeetJobPeer<span class="sy0">::</span><span class="re0">$types</span><span class="sy0">,</span>
  <span class="st_h">'expanded'</span> <span class="sy0">=&gt;</span> <span class="kw4">true</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El widget <code>sfWidgetFormChoice</code> no tiene un equivalente directo en forma de etiqueta HTML, ya que se muestra de forma diferente en función del valor de sus opciones de configuración <code>expanded</code> y <code>multiple</code>:</p>

<ul>
<li>Lista desplegable (<code>&lt;select&gt;</code>): <code>array('multiple' =&gt; false, 'expanded' =&gt; false)</code></li>
<li>Lista desplegable que permite seleccionar varios valores (<code>&lt;select multiple="multiple"&gt;</code>): <code>array('multiple' =&gt; true, 'expanded' =&gt; false)</code></li>
<li>Lista de <em>radio buttons</em>: <code>array('multiple' =&gt; false, 'expanded' =&gt; true)</code></li>
<li>Lista de <em>checkboxes</em>: <code>array('multiple' =&gt; true, 'expanded' =&gt; true)</code></li>
</ul>

<div class="admonition note"><p><strong class="title">Nota</strong> Si quieres que uno de los <em>radio button</em> se muestre seleccionado inicialmente (<code>full-time</code> por ejemplo), puedes modificar su valor por defecto en el esquema de datos.</p></div>

<p>Restringir los posibles valores de un campo de formulario no evita que usuarios malintencionados con conocimientos avanzados puedan manipular sus valores con herramientas como <a href="http://curl.haxx.se/">curl</a> o la <a href="http://chrispederick.com/work/web-developer/">extensión Web Developer Toolbar de Firefox</a>. Por este motivo, vamos a modificar también el validador para restringir los posibles valores a elegir:</p>

<div class="code php">
<pre class="php"><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'type'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorChoice<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
  <span class="st_h">'choices'</span> <span class="sy0">=&gt;</span> <span class="kw3">array_keys</span><span class="br0">&#40;</span>JobeetJobPeer<span class="sy0">::</span><span class="re0">$types</span><span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>Por otra parte, la columna <code>logo</code> almacena el nombre del archivo que contiene el logotipo asociado con la oferta de trabajo, por lo que debemos cambiar su widget para que muestre un campo de formulario para elegir un archivo:</p>

<div class="code php">
<pre class="php"><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="br0">&#91;</span><span class="st_h">'logo'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfWidgetFormInputFile<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
  <span class="st_h">'label'</span> <span class="sy0">=&gt;</span> <span class="st_h">'Company logo'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>Symfony también genera para cada campo una etiqueta o título que se muestra en la etiqueta <code>&lt;label&gt;</code>. La etiqueta generada se puede modificar con la opción <code>label</code>. También es posible modificar varias etiquetas a la vez utilizando el método <code>setLabels()</code> del array de widgets:</p>

<div class="code php">
<pre class="php"><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="sy0">-&gt;</span><span class="me1">setLabels</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
  <span class="st_h">'category_id'</span>    <span class="sy0">=&gt;</span> <span class="st_h">'Category'</span><span class="sy0">,</span>
  <span class="st_h">'is_public'</span>      <span class="sy0">=&gt;</span> <span class="st_h">'Public?'</span><span class="sy0">,</span>
  <span class="st_h">'how_to_apply'</span>   <span class="sy0">=&gt;</span> <span class="st_h">'How to apply?'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>Además, debemos modificar el validador por defecto del campo <code>logo</code>:</p>

<div class="code php">
<pre class="php"><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'logo'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorFile<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
  <span class="st_h">'required'</span>   <span class="sy0">=&gt;</span> <span class="kw4">false</span><span class="sy0">,</span>
  <span class="st_h">'path'</span>       <span class="sy0">=&gt;</span> sfConfig<span class="sy0">::</span><span class="me2">get</span><span class="br0">&#40;</span><span class="st_h">'sf_upload_dir'</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st_h">'/jobs'</span><span class="sy0">,</span>
  <span class="st_h">'mime_types'</span> <span class="sy0">=&gt;</span> <span class="st_h">'web_images'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>El validador <code>sfValidatorFile</code> es muy interesante porque realiza varias tareas:</p>

<ul>
<li>Valida que el archivo subido sea una imagen en un formato adecuado para las páginas web (gracias a la opción <code>mime_types</code>)</li>
<li>Cambia el nombre del archivo por un valor único</li>
<li>Guarda el archivo en la ruta indicada con la opción <code>path</code></li>
<li>Actualiza el valor de la columna <code>logo</code> con el nombre generado anteriormente</li>
</ul>

<div class="admonition note"><p><strong class="title">Nota</strong> No te olvides de crear el directorio para guardar los logotipos (<code>web/uploads/jobs/</code>) y asegúrate que el servidor web tenga permisos de escritura sobre ese directorio.</p></div>

<p>Como el validador sólo guarda en la base de datos la ruta relativa hasta la imagen, modifica la ruta utilizada en la plantilla <code>showSuccess</code>:</p>

<div class="code php">
<pre class="php">// apps/frontend/modules/job/templates/showSuccess.php
&lt;img src=&quot;/uploads/jobs/<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="re0">$job</span><span class="sy0">-&gt;</span><span class="me1">getLogo</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>&quot; alt=&quot;<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="re0">$job</span><span class="sy0">-&gt;</span><span class="me1">getCompany</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span> logo&quot; /&gt;</pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si en el modelo existe un método llamado <code>generateLogoFilename()</code>, el validador utiliza este método para generar automáticamente el nombre del archivo subido. Al método anterior se le pasa como argumento el objeto <code>sfValidatedFile</code>.</p></div>

<p>Además de poder redefinir el valor de las etiquetas generadas para los campos del formulario, también puedes establecer un mensaje de ayuda. Vamos a añadir un mensaje de ayuda para explicar mejor la finalidad del campo <code>is_public</code>:</p>

<div class="code php">
<pre class="php"><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="sy0">-&gt;</span><span class="me1">setHelp</span><span class="br0">&#40;</span><span class="st_h">'is_public'</span><span class="sy0">,</span> <span class="st_h">'Whether the job can also be published on affiliate websites or not.'</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>Combinando todo lo que hemos hecho en esta sección, la clase <code>JobeetJobForm</code> definitiva contiene el siguiente código:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/form/JobeetJobForm.class.php</span>
<span class="kw2">class</span> JobeetJobForm <span class="kw2">extends</span> BaseJobeetJobForm
<span class="br0">&#123;</span>
  <span class="kw2">public</span> <span class="kw2">function</span> configure<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw3">unset</span><span class="br0">&#40;</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'created_at'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'updated_at'</span><span class="br0">&#93;</span><span class="sy0">,</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'expires_at'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'is_activated'</span><span class="br0">&#93;</span>
    <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'email'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorAnd<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
      <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'email'</span><span class="br0">&#93;</span><span class="sy0">,</span>
      <span class="kw2">new</span> sfValidatorEmail<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="br0">&#91;</span><span class="st_h">'type'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfWidgetFormChoice<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
      <span class="st_h">'choices'</span> <span class="sy0">=&gt;</span> JobeetJobPeer<span class="sy0">::</span><span class="re0">$types</span><span class="sy0">,</span>
      <span class="st_h">'expanded'</span> <span class="sy0">=&gt;</span> <span class="kw4">true</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'type'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorChoice<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
      <span class="st_h">'choices'</span> <span class="sy0">=&gt;</span> <span class="kw3">array_keys</span><span class="br0">&#40;</span>JobeetJobPeer<span class="sy0">::</span><span class="re0">$types</span><span class="br0">&#41;</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="br0">&#91;</span><span class="st_h">'logo'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfWidgetFormInputFile<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
      <span class="st_h">'label'</span> <span class="sy0">=&gt;</span> <span class="st_h">'Company logo'</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="sy0">-&gt;</span><span class="me1">setLabels</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
      <span class="st_h">'category_id'</span>    <span class="sy0">=&gt;</span> <span class="st_h">'Category'</span><span class="sy0">,</span>
      <span class="st_h">'is_public'</span>      <span class="sy0">=&gt;</span> <span class="st_h">'Public?'</span><span class="sy0">,</span>
      <span class="st_h">'how_to_apply'</span>   <span class="sy0">=&gt;</span> <span class="st_h">'How to apply?'</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">validatorSchema</span><span class="br0">&#91;</span><span class="st_h">'logo'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">new</span> sfValidatorFile<span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
      <span class="st_h">'required'</span>   <span class="sy0">=&gt;</span> <span class="kw4">false</span><span class="sy0">,</span>
      <span class="st_h">'path'</span>       <span class="sy0">=&gt;</span> sfConfig<span class="sy0">::</span><span class="me2">get</span><span class="br0">&#40;</span><span class="st_h">'sf_upload_dir'</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st_h">'/jobs'</span><span class="sy0">,</span>
      <span class="st_h">'mime_types'</span> <span class="sy0">=&gt;</span> <span class="st_h">'web_images'</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">widgetSchema</span><span class="sy0">-&gt;</span><span class="me1">setHelp</span><span class="br0">&#40;</span><span class="st_h">'is_public'</span><span class="sy0">,</span> <span class="st_h">'Whether the job can also be published on affiliate websites or not.'</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<h3 id="la_plantilla_del_formulario">10.3.2. La plantilla del formulario</h3>

<p>Después de personalizar los campos del formulario, el siguiente paso consiste en mostrarlos. La plantilla del formulario es la misma para el formulario de insertar una oferta de trabajo y para el formulario de modificar los datos de una oferta existente. De hecho, tanto la plantilla <code>newSuccess.php</code> como la plantilla <code>editSuccess.php</code> son muy similares:</p>

<div class="code php">
<pre class="php">&lt;!-- apps/frontend/modules/job/templates/newSuccess.php --&gt;
<span class="kw2">&lt;?php</span> use_stylesheet<span class="br0">&#40;</span><span class="st_h">'job.css'</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>
&nbsp;
&lt;h1&gt;Post a Job&lt;/h1&gt;
&nbsp;
<span class="kw2">&lt;?php</span> include_partial<span class="br0">&#40;</span><span class="st_h">'form'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'form'</span> <span class="sy0">=&gt;</span> <span class="re0">$form</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si todavía no has añadido la hoja de estilos <code>job</code>, debes añadirla en las dos plantillas mediante la instrucción <code>&lt;?php use_stylesheet('job.css') ?&gt;</code></p></div>

<p>El formulario se muestra a través de un elemento parcial llamado <code>_form</code>. Reemplaza el contenido de ese elemento parcial <code>_form</code> por el siguiente código:</p>

<div class="code php">
<pre class="php">&lt;!-- apps/frontend/modules/job/templates/_form.php --&gt;
<span class="kw2">&lt;?php</span> include_stylesheets_for_form<span class="br0">&#40;</span><span class="re0">$form</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>
<span class="kw2">&lt;?php</span> include_javascripts_for_form<span class="br0">&#40;</span><span class="re0">$form</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>
&nbsp;
<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> form_tag_for<span class="br0">&#40;</span><span class="re0">$form</span><span class="sy0">,</span> <span class="st_h">'@job'</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>
  &lt;table id=&quot;job_form&quot;&gt;
    &lt;tfoot&gt;
      &lt;tr&gt;
        &lt;td colspan=&quot;2&quot;&gt;
          &lt;input type=&quot;submit&quot; value=&quot;Preview your job&quot; /&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;/tfoot&gt;
    &lt;tbody&gt;
      <span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="re0">$form</span> <span class="sy1">?&gt;</span>
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/form&gt;</pre>
</div>

<p>Los helpers <code>include_javascripts_for_form()</code> y <code>include_stylesheets_for_form()</code> incluyen respectivamente los archivos JavaScript y CSS que utilizan los widgets del formulario.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> Aunque el formulario para insertar una nueva oferta de trabajo no utiliza ningún archivo JavaScript o CSS, te recomendamos que dejes la llamada a estos helpers <em>"por si acaso"</em>. Estas llamadas pueden venir muy bien posteriormente cuando decidas insertar algún widget que requiere JavaScript o CSS.</p></div>

<p>El helper <code>form_tag_for()</code> genera una etiqueta <code>&lt;form&gt;</code> a partir del formulario y ruta indicados y modifica el método HTTP a <code>POST</code> o <code>PUT</code> dependiendo de si el objeto es nuevo o no. Este helper también tiene en cuenta si es necesario añadir el atributo <code>enctype</code> en caso de que el formulario permite adjuntar archivos.</p>

<p>Por último, la instrucción <code>&lt;?php echo $form ?&gt;</code> se encarga de generar el código HTML de los widgets del formulario.</p>

<div class="admonition sidebar"><p><strong class="title">Modificando el aspecto de un formulario</strong> La instrucción <code>&lt;?php echo $form ?&gt;</code> muestra por defecto cada widget del formulario en una fila de una tabla. No obstante, en muchas ocasiones necesitas cambiar la disposición de los elementos del formulario. Por este motivo, el objeto que representa al formulario incluye varios métodos útiles para modificar su disposición:</p>

<div class="table" id="table_10_1">

    <table>
<thead>
<tr>
  <th>Método</th>
  <th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>render()</code></td>
  <td>Muestra el formulario (equivalente a lo que muestra <code>echo $form</code>)</td>
</tr>
<tr>
  <td><code>renderHiddenFields()</code></td>
  <td>Muestra los campos ocultos</td>
</tr>
<tr>
  <td><code>hasErrors()</code></td>
  <td>Devuelve <code>true</code> si existe algún error en el formulario</td>
</tr>
<tr>
  <td><code>hasGlobalErrors()</code></td>
  <td>Devuelve <code>true</code> si existe algún error global en el formulario</td>
</tr>
<tr>
  <td><code>getGlobalErrors()</code></td>
  <td>Devuelve un array con los errores globales</td>
</tr>
<tr>
  <td><code>renderGlobalErrors()</code></td>
  <td>Muestra los errores globales</td>
</tr>
</tbody>
</table>
</div>


<p>El formulario también se puede manejar como si fuera un array de campos de formulario. Puedes acceder por ejemplo al campo <code>company</code> mediante <code>$form['company']</code>. El objeto devuelto incluye los métodos necesarios para mostrar cada campo del formulario:</p>

<div class="table" id="table_10_2">

    <table>
<thead>
<tr>
  <th>Método</th>
  <th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>renderRow()</code></td>
  <td>Muestra la fila de un campo</td>
</tr>
<tr>
  <td><code>render()</code></td>
  <td>Muestra el widget asociado con el campo</td>
</tr>
<tr>
  <td><code>renderLabel()</code></td>
  <td>Muestra el título o etiqueta de un campo</td>
</tr>
<tr>
  <td><code>renderError()</code></td>
  <td>Muestra los posibles mensajes de error del campo</td>
</tr>
<tr>
  <td><code>renderHelp()</code></td>
  <td>Muestra el mensaje de ayuda del campo</td>
</tr>
</tbody>
</table>
</div>


<p>La instrucción <code>echo $form</code> es equivalente a:</p>

<div class="code php">
<pre class="php"><span class="kw2">&lt;?php</span> <span class="kw1">foreach</span> <span class="br0">&#40;</span><span class="re0">$form</span> <span class="kw1">as</span> <span class="re0">$widget</span><span class="br0">&#41;</span><span class="sy0">:</span> <span class="sy1">?&gt;</span>
  <span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="re0">$widget</span><span class="sy0">-&gt;</span><span class="me1">renderRow</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>
<span class="kw2">&lt;?php</span> <span class="kw1">endforeach</span><span class="sy0">;</span> <span class="sy1">?&gt;</span></pre>
</div>

<p></p></div>

<h3 id="la_accion_del_formulario">10.3.3. La acción del formulario</h3>

<p>Ahora que ya tenemos la clase del formulario y la plantilla que lo muestra, vamos a utilizarlo en algunas acciones. El formulario de las ofertas de trabajo lo utilizan los siguientes cinco métodos del módulo <code>job</code>:</p>

<ul>
<li><strong>new</strong>: muestra un formulario vacío para insertar una nueva oferta de trabajo.</li>
<li><strong>edit</strong>: muestra un formulario para modificar los datos almacenados de una oferta de trabajo.</li>
<li><strong>create</strong>: crea una nueva oferta de trabajo a partir de los datos enviados por el usuario con el formulario.</li>
<li><strong>update</strong>: actualiza los datos de una oferta de trabajo existente a partir de los datos enviados por el usuario con el formulario.</li>
<li><strong>processForm</strong>: este método lo utilizan los métodos <code>create</code> y <code>update</code> para procesar el formulario (validación, volver a mostrar los datos del formulario y guardado o serialización en la base de datos).</li>
</ul>

<p>El flujo de trabajo de todos los formularios se muestra en la siguiente imagen:</p>

<div class="figure" id="figure_10_1">
    <img src="../../img/jobeet_1_4/f1001.png" alt="Flujo de trabajo de los formularios" />

    <p class="caption"><strong>Figura 10.1</strong> Flujo de trabajo de los formularios</p>
</div>


<p>Como en un tutorial pasado creamos una colección de rutas de Propel para el módulo <code>job</code>, podemos simplificar el código de los métodos que gestionan el formulario:</p>

<div class="code php">
<pre class="php"><span class="co1">// apps/frontend/modules/job/actions/actions.class.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> executeNew<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span> <span class="sy0">=</span> <span class="kw2">new</span> JobeetJobForm<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">public</span> <span class="kw2">function</span> executeCreate<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span> <span class="sy0">=</span> <span class="kw2">new</span> JobeetJobForm<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">processForm</span><span class="br0">&#40;</span><span class="re0">$request</span><span class="sy0">,</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">setTemplate</span><span class="br0">&#40;</span><span class="st_h">'new'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">public</span> <span class="kw2">function</span> executeEdit<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span> <span class="sy0">=</span> <span class="kw2">new</span> JobeetJobForm<span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getRoute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getObject</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">public</span> <span class="kw2">function</span> executeUpdate<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span> <span class="sy0">=</span> <span class="kw2">new</span> JobeetJobForm<span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getRoute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getObject</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">processForm</span><span class="br0">&#40;</span><span class="re0">$request</span><span class="sy0">,</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">setTemplate</span><span class="br0">&#40;</span><span class="st_h">'edit'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">public</span> <span class="kw2">function</span> executeDelete<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">checkCSRFProtection</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
  <span class="re0">$job</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getRoute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getObject</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="re0">$job</span><span class="sy0">-&gt;</span><span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">redirect</span><span class="br0">&#40;</span><span class="st_h">'job/index'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">protected</span> <span class="kw2">function</span> processForm<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="sy0">,</span> sfForm <span class="re0">$form</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$form</span><span class="sy0">-&gt;</span><span class="me1">bind</span><span class="br0">&#40;</span>
    <span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">getParameter</span><span class="br0">&#40;</span><span class="re0">$form</span><span class="sy0">-&gt;</span><span class="me1">getName</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">,</span>
    <span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">getFiles</span><span class="br0">&#40;</span><span class="re0">$form</span><span class="sy0">-&gt;</span><span class="me1">getName</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
  <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
  <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$form</span><span class="sy0">-&gt;</span><span class="me1">isValid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="re0">$job</span> <span class="sy0">=</span> <span class="re0">$form</span><span class="sy0">-&gt;</span><span class="me1">save</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">redirect</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">generateUrl</span><span class="br0">&#40;</span><span class="st_h">'job_show'</span><span class="sy0">,</span> <span class="re0">$job</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Cada vez que se accede a la página <code>/job/new</code>, se crea una nueva instancia de un formulario y se pasa a la plantilla en la acción <code>new</code>.</p>

<p>Cuando el usuario envía el formulario (acción <code>create</code>), se asocia (mediante el método <code>bind()</code>) con los valores enviados por el usuario y se ejecuta la validación de los datos.</p>

<p>Cuando el formulario está asociado, ya se puede comprobar su validez con el método <code>isValid()</code>. Si el formulario es válido (el método <code>isValid()</code> devuelve <code>true</code>), la oferta de trabajo se guarda en la base de datos (<code>$form-&gt;save()</code>) y se redirige al usuario a la página que previsualiza la oferta. Si el formulario no es válido, se vuelve a mostrar la plantilla <code>newSuccess.php</code> con los mismos datos que envió el usuario y con todos los mensajes de error asociados.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> El método <code>setTemplate()</code> modifica la plantilla utilizada por la acción. Si el formulario enviado no es válido, los métodos <code>create</code> y <code>update</code> utilizan la misma plantilla para volver a mostrar en las acciones <code>new</code> y <code>edit</code> el formulario con los mensajes de error asociados.</p></div>

<p>La modificación de una oferta de trabajo existente es un proceso muy similar. La única diferencia entre la acción <code>new</code> y la acción <code>edit</code> es que en el segundo caso, se pasa como primer argumento del constructor del formulario el objeto que representa la oferta de trabajo que se va a modificar. Este objeto se emplea para establecer los valores iniciales de los widgets de la plantilla (en los formularios de Propel los valores iniciales forman un objeto, pero en los formularios sencillos se indican en forma de array simple).</p>

<p>El formulario para insertar una nueva oferta de trabajo también puede mostrar unos determinados valores iniciales. Una forma sencilla de conseguirlo es declarar esos valores iniciales en el esquema de la base de datos. Otra forma consiste en pasar un objeto modificado de tipo <code>Job</code> al constructor del formulario.</p>

<p>Modifica el método <code>executeNew()</code> para establecer el valor <code>full-time</code> como valor por defecto de la columna <code>type</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// apps/frontend/modules/job/actions/actions.class.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> executeNew<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$job</span> <span class="sy0">=</span> <span class="kw2">new</span> JobeetJob<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="re0">$job</span><span class="sy0">-&gt;</span><span class="kw3">setType</span><span class="br0">&#40;</span><span class="st_h">'full-time'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">form</span> <span class="sy0">=</span> <span class="kw2">new</span> JobeetJobForm<span class="br0">&#40;</span><span class="re0">$job</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Cuando el formulario se asocia a los datos del usuario, los valores iniciales se reemplazan por los valores enviados por el usuario. Estos valores se utilizan cuando el formulario debe volver a mostrar los datos introducidos por el usuario después de que la validación no haya sido satisfactoria.</p></div>

<h3 id="protegiendo_el_formulario_de_las_ofertas_de_trabajo_con_un_token">10.3.4. Protegiendo el formulario de las ofertas de trabajo con un token</h3>

<p>Ahora mismo el formulario funciona correctamente y el usuario debe indicar el token de la oferta de trabajo. No obstante, el token asociado con la oferta de trabajo se debe generar automáticamente cada vez que se crea una oferta de trabajo, ya que no queremos que sean los usuarios los que tengan que indicar un token único.</p>

<p>Para ello, modifica el método <code>save()</code> de <code>JobeetJob</code> para añadir la lógica que genera el token antes de guardar la oferta de trabajo:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/model/JobeetJob.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> save<span class="br0">&#40;</span>PropelPDO <span class="re0">$con</span> <span class="sy0">=</span> <span class="kw4">null</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="co1">// ...</span>
&nbsp;
  <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getToken</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">setToken</span><span class="br0">&#40;</span><span class="kw3">sha1</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getEmail</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="kw3">rand</span><span class="br0">&#40;</span><span class="nu0">11111</span><span class="sy0">,</span> <span class="nu0">99999</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">return</span> parent<span class="sy0">::</span><span class="me2">save</span><span class="br0">&#40;</span><span class="re0">$con</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Ahora ya puedes eliminar el campo <code>token</code> del formulario:</p>

<div class="code php">
<pre class="php"><span class="co1">// lib/form/JobeetJobForm.class.php</span>
<span class="kw2">class</span> JobeetJobForm <span class="kw2">extends</span> BaseJobeetJobForm
<span class="br0">&#123;</span>
  <span class="kw2">public</span> <span class="kw2">function</span> configure<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw3">unset</span><span class="br0">&#40;</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'created_at'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'updated_at'</span><span class="br0">&#93;</span><span class="sy0">,</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'expires_at'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'is_activated'</span><span class="br0">&#93;</span><span class="sy0">,</span>
      <span class="re0">$this</span><span class="br0">&#91;</span><span class="st_h">'token'</span><span class="br0">&#93;</span>
    <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// ...</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Si recuerdas los escenarios que describimos durante el tutorial del día 2, una oferta de trabajo sólo se puede editar si el usuario conoce su token asociado. Ahora mismo es muy sencillo modificar o borrar cualquier oferta de trabajo adivinando su URL. El motivo es que la URL de la acción de modificar la oferta de trabajo siempre es <code>/job/ID/edit</code>, donde <code>ID</code> es la clave primaria de la oferta de trabajo.</p>

<p>Las rutas de tipo <code>sfPropelRouteCollection</code> generan por defecto URL que contienen el valor de la clave primaria, pero se puede modificar por cualquier otra columna cuyo valor sea único indicándolo en la opción <code>column</code>:</p>

<div class="code yaml">
<pre class="yaml"><span class="co1"># apps/frontend/config/routing.yml</span><span class="co4">
job</span>:<span class="co3">
  class</span><span class="sy2">: </span>       sfPropelRouteCollection<span class="co3">
  options</span><span class="sy2">: </span>     <span class="br0">&#123;</span> model<span class="sy2">: </span>JobeetJob, column<span class="sy2">: </span>token <span class="br0">&#125;</span><span class="co3">
  requirements</span><span class="sy2">: </span><span class="br0">&#123;</span> token<span class="sy2">: </span>\w+ <span class="br0">&#125;</span></pre>
</div>

<p>En la configuración de la ruta anterior también hemos modificado la opción <code>requirements</code> para la columna del <code>token</code>, ya que el requisito por defecto de Symfony para una clave primaria es <code>\d+</code></p>

<p>Ahora, todas las rutas relacionadas con las ofertas de trabajo salvo <code>job_show_user</code>, incluyen el token y no la clave primaria. La ruta para editar una oferta de trabajo por ejemplo tiene el siguiente aspecto:</p>

<div class="code code">
<pre class="code">http://jobeet.localhost/job/TOKEN/edit</pre>
</div>

<p>No te olvides de modificar también el enlace de la plantilla <code>showSuccess</code>:</p>

<div class="code php">
<pre class="php">&lt;!-- apps/frontend/modules/job/templates/showSuccess.php --&gt;
&lt;a href=&quot;<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> url_for<span class="br0">&#40;</span><span class="st_h">'job_edit'</span><span class="sy0">,</span> <span class="re0">$job</span><span class="br0">&#41;</span> <span class="sy1">?&gt;</span>&quot;&gt;Edit&lt;/a&gt;</pre>
</div>



    <div class="navigation row">
            <a class="span4 prev" href="formularios.html">&larr; Anterior <span>10.2. Formularios</span></a>
            
            <a class="span5 next" href="la_pagina_de_previsualizacion.html">Siguiente &rarr; <span>10.4. La página de previsualización</span></a>
        </div>
</div>

<div class="span3 side">
<h3 class="underline"><span>Compartir</span></h3>
<ul class="share">
    <li><a class="twitter" id="share_twitter" href="#" title="Compartir este artículo en Twitter">tw</a></li>
    <li><a class="facebook" id="share_facebook" href="#" title="Compartir este artículo en Facebook">fb</a></li>
    <li><a class="google" id="share_google" href="#" title="Compartir este artículo en Google+">g+</a></li>
</ul>

<script type="text/javascript">
var title    = 'Formularios de Propel (El tutorial Jobeet%29';
var page_url = encodeURIComponent(window.location);
var options  = 'menubar=no,toolbar=no,resizable=yes,scrollbars=no,width=640,height=350';
var services = {
    share_twitter:  'https://twitter.com/share?text=' + title + '&lang=es&hashtags=librosweb',
    share_facebook: 'http://www.facebook.com/sharer.php?u=' + page_url + '&t=' + title,
    share_google:   'https://plus.google.com/share?url=' + page_url + '&hl=es'
};

for (var id in services) { // don't use services.keys() for compatibility reasons
    if (services.hasOwnProperty(id)) {
        document.getElementById(id).href = services[id];
        document.getElementById(id).onclick = function(a) {
            a = a || window.event;
            a = a.target || a.srcElement;
            _gaq.push(['_trackEvent', 'share', a.id.substr(6), 'El tutorial Jobeet : Formularios de Propel']);
            window.open(services[a.id], a.title, options);

            return false;
        };
    }
}
</script>

<h3 class="underline"><span>Indice de contenidos</span></h3>
<ul class="toc">
    <li class="level-1">
        <span>1</span> <a href="../capitulo_1.html"> Comenzando el proyecto</a>
    </li>
    <li class="level-1">
        <span>2</span> <a href="../capitulo_2.html"> El proyecto</a>
    </li>
    <li class="level-1">
        <span>3</span> <a href="../capitulo_3.html"> El modelo de datos</a>
    </li>
    <li class="level-1">
        <span>4</span> <a href="../capitulo_4.html"> El controlador y la vista</a>
    </li>
    <li class="level-1">
        <span>5</span> <a href="../capitulo_5.html"> El sistema de enrutamiento</a>
    </li>
    <li class="level-1">
        <span>6</span> <a href="../capitulo_6.html"> Profundizando en el modelo</a>
    </li>
    <li class="level-1">
        <span>7</span> <a href="../capitulo_7.html"> Trabajando con la página de cada categoría</a>
    </li>
    <li class="level-1">
        <span>8</span> <a href="../capitulo_8.html"> Pruebas unitarias</a>
    </li>
    <li class="level-1">
        <span>9</span> <a href="../capitulo_9.html"> Pruebas funcionales</a>
    </li>
    <li class="level-1 ">
        <a href="../capitulo_10.html">
            <span>Capítulo 10.</span> Los formularios
        </a>
    </li>
    <li class="level-2 ">
        <a href="el_framework_de_formularios.html">
            <span>10.1.</span> El framework de formularios
        </a>
    </li>
    <li class="level-2 ">
        <a href="formularios.html">
            <span>10.2.</span> Formularios
        </a>
    </li>
    <li class="level-2 active">
        <a href="formularios_de_propel.html">
            <span>10.3.</span> Formularios de Propel
        </a>
    </li>
    <li class="level-2 ">
        <a href="la_pagina_de_previsualizacion.html">
            <span>10.4.</span> La página de previsualización
        </a>
    </li>
    <li class="level-2 ">
        <a href="activando_y_publicando_las_ofertas_de_trabajo.html">
            <span>10.5.</span> Activando y publicando las ofertas de trabajo
        </a>
    </li>
    <li class="level-2 ">
        <a href="nos_vemos_manana.html">
            <span>10.6.</span> Nos vemos mañana
        </a>
    </li>
    <li class="level-1">
        <span>11</span> <a href="../capitulo_11.html"> Probando los formularios</a>
    </li>
    <li class="level-1">
        <span>12</span> <a href="../capitulo_12.html"> El generador de la parte de administración</a>
    </li>
    <li class="level-1">
        <span>13</span> <a href="../capitulo_13.html"> El usuario</a>
    </li>
    <li class="level-1">
        <span>14</span> <a href="../capitulo_14.html"> El día de descanso</a>
    </li>
    <li class="level-1">
        <span>15</span> <a href="../capitulo_15.html"> Canales Atom</a>
    </li>
    <li class="level-1">
        <span>16</span> <a href="../capitulo_16.html"> Servicios web</a>
    </li>
    <li class="level-1">
        <span>17</span> <a href="../capitulo_17.html"> El buscador</a>
    </li>
    <li class="level-1">
        <span>18</span> <a href="../capitulo_18.html"> AJAX</a>
    </li>
    <li class="level-1">
        <span>19</span> <a href="../capitulo_19.html"> Internacionalización y localización</a>
    </li>
    <li class="level-1">
        <span>20</span> <a href="../capitulo_20.html"> Plugins</a>
    </li>
    <li class="level-1">
        <span>21</span> <a href="../capitulo_21.html"> El día del diseño</a>
    </li>
    <li class="level-1">
        <span>22</span> <a href="../capitulo_22.html"> La cache</a>
    </li>
    <li class="level-1">
        <span>23</span> <a href="../capitulo_23.html"> Pasando a producción</a>
    </li>
    <li class="level-1">
        <span>24</span> <a href="../capitulo_24.html"> Un repaso a Symfony</a>
    </li>
</ul>
</div>
        </div></div>
        <div id="footer" class="row">
            <span class="span6">&copy; 2013 LibrosWeb.es 
            <a href="../../contacto/index.html">Contacto</a></span>
            <span class="span6 version">2.340 días online</span>
        </div>
    </div>
    </body>
</html>

<!-- Localized -->