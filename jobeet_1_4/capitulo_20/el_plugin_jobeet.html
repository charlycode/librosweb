<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>20.3. El plugin Jobeet (El tutorial Jobeet)</title>
        <link href="../../css/main-fa23fb7.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-82842-2']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        <link rel="apple-touch-icon" type="image/png" href="../../apple-touch-icon.png" />
        <link rel="apple-touch-icon-precomposed" type="image/png" href="../../apple-touch-icon.png" />
        <meta name="apple-mobile-web-app-title" content="LibrosWeb" />

        <link rel="shortcut icon" type="image/png" href="../../favicon.png" />
        <meta name="site:version" content="fa23fb7" />
        <link rel="author" href="https://plus.google.com/u/0/107307901774377088868" />
        <link rel="prev" href="estructura_de_archivos_de_los_plugins.html" />
        <link rel="next" href="utilizando_los_plugins.html" />
        <link rel="start" href="../index.html" />
        <meta name="twitter:site" content="@librosweb" />
        <link rel="search" type="application/opensearchdescription+xml" href="http://librosweb.es/opensearch/documentation.xml" title="Libros y tutoriales de LibrosWeb.es" />
        <meta property="fb:page_id" content="437758756273955" />
        <meta property="fb:app_id" content="437758756273955" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="20.3. El plugin Jobeet (El tutorial Jobeet)" />
        <meta property="og:image" content="http://www.gravatar.com/avatar/9f219b4dfaa677bfd0f47753c02d5126.png?s=200" />
        <meta name="msapplication-TileColor" content="#CC1414" />
        <meta name="application-name" content="LibrosWeb" />
        <meta name="msapplication-tooltip" content="Libros y tutoriales sobre HTML, CSS, JavaScript, PHP y otras tecnologías web." />
    </head>
    <body class="book_page jobeet_1_4">
    <div id="container" class="container">
        <div id="header">
            <h1><a href="../../index.html" title="LibrosWeb.es">LibrosWeb</a></h1>
            <form action="/buscar"><input type="text" placeholder="buscar..." name="q"/></form>
        </div>
        <div id="content"><div class="row">
        <ul class="breadcrumbs span12">
  <li><a href="../../index.html">Inicio</a></li>
  <li><a href="../index.html">El tutorial Jobeet</a></li>
  <li><a href="../capitulo_20.html">Capítulo 20. Plugins</a></li>
  <li class="current"><span>20.3.. El plugin Jobeet</span></li>
</ul>

<div class="span9">
    <h1 id="el_plugin_jobeet"><span>20.3.</span> El plugin Jobeet</h1>
    

<p>Inicializar un plugin es tan sencillo como crear un nuevo directorio bajo el directorio <code>plugins/</code>. Para el plugin de Jobeet, crea un directorio llamado <code>sfJobeetPlugin</code>:</p>

<div class="code cli">
<pre class="cli">$ mkdir plugins/sfJobeetPlugin</pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> El nombre de todos los plugins debe acabar con la palabra <code>Plugin</code>. También es recomendable utilizar el prefijo <code>sf</code>, aunque no es obligatorio.</p></div>

<h3 id="el_modelo">20.3.1. El modelo</h3>

<p>En primer lugar, mueve el archivo <code>config/schema.yml</code> a <code>plugins/sfJobeetPlugin/config/</code>:</p>

<div class="code cli">
<pre class="cli">$ mkdir plugins/sfJobeetPlugin/config/
$ mv config/schema.yml plugins/sfJobeetPlugin/config/schema.yml</pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Todos los comandos que mostramos en este tutorial son los apropiados para los entornos tipo Unix. Si utilizas Windows, puedes copiar y pegar los archivos utilizando el explorador de archivos. Si utilizas Subversion o cualquier otra herramienta para gestionar tu código, utiliza las herramientas que incluyen para mover código (como por ejemplo <code>svn mv</code> para mover los archivos).</p></div>

<p>A continuación, mueve todos los archivos del modelo, formularios y filtros al directorio <code>plugins/sfJobeetPlugin/lib/</code>:</p>

<div class="code cli">
<pre class="cli">$ mkdir plugins/sfJobeetPlugin/lib/
$ mv lib/model/ plugins/sfJobeetPlugin/lib/
$ mv lib/form/ plugins/sfJobeetPlugin/lib/
$ mv lib/filter/ plugins/sfJobeetPlugin/lib/</pre>
</div>

<p>Si ahora ejecutas la tarea <code>propel:build-model</code>, Symfony sigue generando todos sus archivos en el directorio <code>lib/model/</code>, que es justo lo que no queremos. El directorio en el que Propel genera sus archivos se puede configurar mediante la opción <code>package</code>. Abre el archivo <code>schema.yml</code> y añade la siguiente configuración:</p>

<div class="code yaml">
<pre class="yaml"><span class="co1"># plugins/sfJobeetPlugin/config/schema.yml</span><span class="co4">
propel</span>:<span class="co3">
  _attributes</span><span class="sy2">: </span>     <span class="br0">&#123;</span> package<span class="sy2">: </span>plugins.sfJobeetPlugin.lib.model <span class="br0">&#125;</span></pre>
</div>

<p>Ahora Symfony genera sus archivos en el directorio <code>plugins/sfJobeetPlugin/lib/model/</code>. Los generadores de formularios y de filtros también tienen en consideración esta configuración cuando generan sus archivos.</p>

<p>La tarea <code>propel:build-sql</code> genera un archivo SQL para crear las tablas de la base de datos. Como el archivo se llama igual que el paquete, elimina el archivo actual:</p>

<div class="code cli">
<pre class="cli">$ rm data/sql/lib.model.schema.sql</pre>
</div>

<p>Si ejecutas ahora la tarea <code>propel:build-all-load</code>, Symfony genera todos sus archivos en el directorio <code>lib/model/</code> del plugin:</p>

<div class="code cli">
<pre class="cli">$ php symfony propel:build-all-load --no-confirmation</pre>
</div>

<p>Después de ejecutar la tarea anterior, asegúrate de que no se ha creado un directorio llamado <code>lib/model/</code>. Sin embargo, la tarea anterior si que ha creado los directorios <code>lib/form/</code> y <code>lib/filter/</code>. Estos directorios incluyen las clases base de todos los formularios Propel del proyecto.</p>

<p>Como estos archivos son globales para un proyecto, puedes eliminarlos en el plugin:</p>

<div class="code cli">
<pre class="cli">$ rm plugins/sfJobeetPlugin/lib/form/BaseFormPropel.class.php
$ rm plugins/sfJobeetPlugin/lib/filter/BaseFormFilterPropel.class.php</pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si utilizas Symfony 1.2.0 o 1.2.1, el archivo del formulario base de los filtros se encuentra en el directorio <code>plugins/sfJobeetPlugin/lib/filter/base/</code>.</p></div>

<p>También puedes mover el archivo <code>Jobeet.class.php</code> al plugin:</p>

<div class="code cli">
<pre class="cli">$ mv lib/Jobeet.class.php plugins/sfJobeetPlugin/lib/</pre>
</div>

<p>Como hemos movido muchos archivos y clases, no te olvides de borrar la cache de Symfony:</p>

<div class="code cli">
<pre class="cli">$ php symfony cc</pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si utilizas un acelerador de PHP tipo APC, es posible que se produzcan algunos errores en este punto, por lo que te recomendamos que reinicies Apache.</p></div>

<p>Después de mover todos los archivos del modelo al plugin, ejecuta las pruebas automáticas para comprobar que todo sigue funcionando correctamente:</p>

<div class="code cli">
<pre class="cli">$ php symfony test:all</pre>
</div>

<h3 id="los_controladores_y_las_vistas">20.3.2. Los controladores y las vistas</h3>

<p>El siguiente paso lógico consiste en mover los módulos al directorio del plugin. Para evitar duplicidades con el nombre de los módulos, te aconsejamos prefijar el nombre de cada módulo con el nombre del propio plugin:</p>

<div class="code cli">
<pre class="cli">$ mkdir plugins/sfJobeetPlugin/modules/
$ mv apps/frontend/modules/affiliate plugins/sfJobeetPlugin/modules/sfJobeetAffiliate
$ mv apps/frontend/modules/api plugins/sfJobeetPlugin/modules/sfJobeetApi
$ mv apps/frontend/modules/category plugins/sfJobeetPlugin/modules/sfJobeetCategory
$ mv apps/frontend/modules/job plugins/sfJobeetPlugin/modules/sfJobeetJob
$ mv apps/frontend/modules/language plugins/sfJobeetPlugin/modules/sfJobeetLanguage</pre>
</div>

<p>No te olvides de modificar también el nombre de la clase en todos los archivos <code>actions.class.php</code> y <code>components.class.php</code> de cada módulo (por ejemplo, la clase <code>affiliateActions</code> se debe renombrar a <code>sfJobeetAffiliateActions</code>).</p>

<p>Cambia también las llamadas a <code>include_partial()</code> y <code>include_component()</code> en las siguientes plantillas:</p>

<ul>
<li><code>sfJobeetAffiliate/templates/_form.php</code> (cambia <code>affiliate</code> por <code>sfJobeetAffiliate</code>)</li>
<li><code>sfJobeetCategory/templates/showSuccess.atom.php</code></li>
<li><code>sfJobeetCategory/templates/showSuccess.php</code></li>
<li><code>sfJobeetJob/templates/indexSuccess.atom.php</code></li>
<li><code>sfJobeetJob/templates/indexSuccess.php</code></li>
<li><code>sfJobeetJob/templates/searchSuccess.php</code></li>
<li><code>sfJobeetJob/templates/showSuccess.php</code></li>
<li><code>apps/frontend/templates/layout.php</code></li>
</ul>

<p>Actualiza las acciones <code>search</code> y <code>delete</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// plugins/sfJobeetPlugin/modules/sfJobeetJob/actions/actions.class.php</span>
<span class="kw2">class</span> sfJobeetJobActions <span class="kw2">extends</span> sfActions
<span class="br0">&#123;</span>
  <span class="kw2">public</span> <span class="kw2">function</span> executeSearch<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$query</span> <span class="sy0">=</span> <span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">getParameter</span><span class="br0">&#40;</span><span class="st_h">'query'</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">forward</span><span class="br0">&#40;</span><span class="st_h">'sfJobeetJob'</span><span class="sy0">,</span> <span class="st_h">'index'</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">jobs</span> <span class="sy0">=</span> JobeetJobPeer<span class="sy0">::</span><span class="me2">getForLuceneQuery</span><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">isXmlHttpRequest</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="kw1">if</span> <span class="br0">&#40;</span><span class="st_h">'*'</span> <span class="sy0">==</span> <span class="re0">$query</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">jobs</span><span class="br0">&#41;</span>
      <span class="br0">&#123;</span>
        <span class="kw1">return</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">renderText</span><span class="br0">&#40;</span><span class="st_h">'No results.'</span><span class="br0">&#41;</span><span class="sy0">;</span>
      <span class="br0">&#125;</span>
      <span class="kw1">else</span>
      <span class="br0">&#123;</span>
        <span class="kw1">return</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">renderPartial</span><span class="br0">&#40;</span><span class="st_h">'sfJobeetJob/list'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'jobs'</span> <span class="sy0">=&gt;</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">jobs</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
      <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="kw2">public</span> <span class="kw2">function</span> executeDelete<span class="br0">&#40;</span>sfWebRequest <span class="re0">$request</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="re0">$request</span><span class="sy0">-&gt;</span><span class="me1">checkCSRFProtection</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$jobeet_job</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getRoute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getObject</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$jobeet_job</span><span class="sy0">-&gt;</span><span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">redirect</span><span class="br0">&#40;</span><span class="st_h">'sfJobeetJob/index'</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Por último, modifica el archivo <code>routing.yml</code> para que tenga en cuenta todos los cambios anteriores:</p>

<div class="code yaml">
<pre class="yaml"><span class="co1"># apps/frontend/config/routing.yml</span><span class="co4">
affiliate</span>:<span class="co3">
  class</span><span class="sy2">: </span>  sfPropelRouteCollection<span class="co4">
  options</span>:<span class="co3">
    model</span><span class="sy2">: </span>         JobeetAffiliate<span class="co3">
    actions</span><span class="sy2">: </span>       <span class="br0">&#91;</span>new, create<span class="br0">&#93;</span><span class="co3">
    object_actions</span><span class="sy2">: </span><span class="br0">&#123;</span> wait<span class="sy2">: </span>GET <span class="br0">&#125;</span><span class="co3">
    prefix_path</span><span class="sy2">: </span>   /:sf_culture/affiliate<span class="co3">
    module</span><span class="sy2">: </span>        sfJobeetAffiliate<span class="co4">
  requirements</span>:<span class="co3">
    sf_culture</span><span class="sy2">: </span><span class="br0">&#40;</span>?:fr|en<span class="br0">&#41;</span>
<span class="co4">
api_jobs</span>:<span class="co3">
  url</span><span class="sy2">: </span>    /api/:token/jobs.:sf_format<span class="co3">
  class</span><span class="sy2">: </span>  sfPropelRoute<span class="co3">
  param</span><span class="sy2">: </span>  <span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetApi, action<span class="sy2">: </span>list <span class="br0">&#125;</span><span class="co3">
  options</span><span class="sy2">: </span><span class="br0">&#123;</span> model<span class="sy2">: </span>JobeetJob, type<span class="sy2">: </span>list, method<span class="sy2">: </span>getForToken <span class="br0">&#125;</span><span class="co4">
  requirements</span>:<span class="co3">
    sf_format</span><span class="sy2">: </span><span class="br0">&#40;</span>?:xml|json|yaml<span class="br0">&#41;</span>
<span class="co4">
category</span>:<span class="co3">
  url</span><span class="sy2">: </span>    /:sf_culture/category/:slug.:sf_format<span class="co3">
  class</span><span class="sy2">: </span>  sfPropelRoute<span class="co3">
  param</span><span class="sy2">: </span>  <span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetCategory, action<span class="sy2">: </span>show, sf_format<span class="sy2">: </span>html <span class="br0">&#125;</span><span class="co3">
  options</span><span class="sy2">: </span><span class="br0">&#123;</span> model<span class="sy2">: </span>JobeetCategory, type<span class="sy2">: </span>object, method<span class="sy2">: </span>doSelectForSlug <span class="br0">&#125;</span><span class="co4">
  requirements</span>:<span class="co3">
    sf_format</span><span class="sy2">: </span><span class="br0">&#40;</span>?:html|atom<span class="br0">&#41;</span><span class="co3">
    sf_culture</span><span class="sy2">: </span><span class="br0">&#40;</span>?:fr|en<span class="br0">&#41;</span>
<span class="co4">
job_search</span>:<span class="co3">
  url</span><span class="sy2">: </span>  /:sf_culture/search<span class="co3">
  param</span><span class="sy2">: </span><span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetJob, action<span class="sy2">: </span>search <span class="br0">&#125;</span><span class="co4">
  requirements</span>:<span class="co3">
    sf_culture</span><span class="sy2">: </span><span class="br0">&#40;</span>?:fr|en<span class="br0">&#41;</span>
<span class="co4">
job</span>:<span class="co3">
  class</span><span class="sy2">: </span>  sfPropelRouteCollection<span class="co4">
  options</span>:<span class="co3">
    model</span><span class="sy2">: </span>         JobeetJob<span class="co3">
    column</span><span class="sy2">: </span>        token<span class="co3">
    object_actions</span><span class="sy2">: </span><span class="br0">&#123;</span> publish<span class="sy2">: </span>PUT, extend<span class="sy2">: </span>PUT <span class="br0">&#125;</span><span class="co3">
    prefix_path</span><span class="sy2">: </span>   /:sf_culture/job<span class="co3">
    module</span><span class="sy2">: </span>        sfJobeetJob<span class="co4">
  requirements</span>:<span class="co3">
    token</span><span class="sy2">: </span>\w+<span class="co3">
    sf_culture</span><span class="sy2">: </span><span class="br0">&#40;</span>?:fr|en<span class="br0">&#41;</span>
<span class="co4">
job_show_user</span>:<span class="co3">
  url</span><span class="sy2">: </span>    /:sf_culture/job/:company_slug/:location_slug/:id/:position_slug<span class="co3">
  class</span><span class="sy2">: </span>  sfPropelRoute<span class="co4">
  options</span>:<span class="co3">
    model</span><span class="sy2">: </span>JobeetJob<span class="co3">
    type</span><span class="sy2">: </span> object<span class="co3">
    method_for_criteria</span><span class="sy2">: </span>doSelectActive<span class="co3">
  param</span><span class="sy2">: </span>  <span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetJob, action<span class="sy2">: </span>show <span class="br0">&#125;</span><span class="co4">
  requirements</span>:<span class="co3">
    id</span><span class="sy2">: </span>       \d+<span class="co3">
    sf_method</span><span class="sy2">: </span>GET<span class="co3">
    sf_culture</span><span class="sy2">: </span><span class="br0">&#40;</span>?:fr|en<span class="br0">&#41;</span>
<span class="co4">
change_language</span>:<span class="co3">
  url</span><span class="sy2">: </span>  /change_language<span class="co3">
  param</span><span class="sy2">: </span><span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetLanguage, action<span class="sy2">: </span>changeLanguage <span class="br0">&#125;</span>
<span class="co4">
localized_homepage</span>:<span class="co3">
  url</span><span class="sy2">: </span>  /:sf_culture/<span class="co3">
  param</span><span class="sy2">: </span><span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetJob, action<span class="sy2">: </span>index <span class="br0">&#125;</span><span class="co4">
  requirements</span>:<span class="co3">
    sf_culture</span><span class="sy2">: </span><span class="br0">&#40;</span>?:fr|en<span class="br0">&#41;</span>
<span class="co4">
homepage</span>:<span class="co3">
  url</span><span class="sy2">: </span>  /<span class="co3">
  param</span><span class="sy2">: </span><span class="br0">&#123;</span> module<span class="sy2">: </span>sfJobeetJob, action<span class="sy2">: </span>index <span class="br0">&#125;</span></pre>
</div>

<p>Si ahora accedes al sitio web de Jobeet, verás que se muestran excepciones indicando que los módulos no están activados. Como los plugins están disponibles en todas las aplicaciones de un mismo proyecto, debes indicar explícitamente en el archivo de configuración <code>settings.yml</code> los módulos que están activados en cada aplicación:</p>

<div class="code yaml">
<pre class="yaml"><span class="co1"># apps/frontend/config/settings.yml</span><span class="co4">
all</span>:<span class="co4">
  .settings</span>:<span class="co4">
    enabled_modules</span><span class="sy2">:
</span>      - default
      - sfJobeetAffiliate
      - sfJobeetApi
      - sfJobeetCategory
      - sfJobeetJob
      - sfJobeetLanguage</pre>
</div>

<p>El último paso de la migración consiste en arreglar las pruebas funcionales en las que probamos el nombre del módulo.</p>

<div class="admonition sidebar"><p><strong class="title">Activando los plugins</strong> Para que un plugin esté disponible en el proyecto, debes activarlo en la clase <code>ProjectConfiguration</code>. Esta activación no es necesaria con la configuración por defecto, ya que Symfony emplea la estrategia de la <em>lista negra</em>, que activa todos los plugins salvo los que se indican explícitamente:</p>

<div class="code php">
<pre class="php"><span class="co1">// config/ProjectConfiguration.class.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> setup<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">enableAllPluginsExcept</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'sfDoctrinePlugin'</span><span class="sy0">,</span> <span class="st_h">'sfCompat10Plugin'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Esta estrategia se utiliza para mantener la compatibilidad con las versiones anteriores de Symfony, pero te aconsejamos que utilices la estrategia de la <em>lista blanca</em>, donde se activan explícitamente los plugins con el método <code>enablePlugins()</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// config/ProjectConfiguration.class.php</span>
<span class="kw2">public</span> <span class="kw2">function</span> setup<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">enablePlugins</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'sfPropelPlugin'</span><span class="sy0">,</span> <span class="st_h">'sfGuardPlugin'</span><span class="sy0">,</span> <span class="st_h">'sfFormExtraPlugin'</span><span class="sy0">,</span> <span class="st_h">'sfJobeetPlugin'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p></p></div>

<h3 id="las_tareas">20.3.3. Las tareas</h3>

<p>Mover las tareas al plugin es muy sencillo:</p>

<div class="code cli">
<pre class="cli">$ mv lib/task plugins/sfJobeetPlugin/lib/</pre>
</div>

<h3 id="los_archivos_de_internacionalizacion">20.3.4. Los archivos de internacionalización</h3>

<p>Los plugins también pueden contener archivos en formato XLIFF:</p>

<div class="code cli">
<pre class="cli">$ mv apps/frontend/i18n plugins/sfJobeetPlugin/</pre>
</div>

<h3 id="el_sistema_de_enrutamiento">20.3.5. El sistema de enrutamiento</h3>

<p>Los plugins también pueden incluir sus propias reglas en el sistema de enrutamiento:</p>

<div class="code cli">
<pre class="cli">$ mv apps/frontend/config/routing.yml plugins/sfJobeetPlugin/config/</pre>
</div>

<h3 id="los_archivos_css_y_javascript">20.3.6. Los archivos CSS y JavaScript</h3>

<p>A pesar de que puede no parecer evidente, los plugins también pueden contener archivos web como imágenes, hojas de estilos y archivos JavaScript. Como no vamos a redistribuir Jobeet como plugin, no tiene sentido que añadamos todos estos archivos, pero si quieres hacerlo, crea un directorio llamado <code>plugins/sfJobeetPlugin/web/</code> y copia en el todos estos archivos.</p>

<p>Para que los archivos web del plugin se puedan ver desde el navegador, es necesario hacerlos accesibles en el directorio <code>web/</code> del proyecto. La tarea <code>plugin:publish-assets</code> se encarga de ello creando enlaces simbólicos en sistemas operativos Unix y copiando los archivos en sistemas operativos Windows:</p>

<div class="code cli">
<pre class="cli">$ php symfony plugin:publish-assets</pre>
</div>

<h3 id="el_usuario">20.3.7. El usuario</h3>

<p>Mover los métodos de la clase <code>myUser</code> que se encargan de crear el historial de las ofertas de trabajo visitadas es un poco más complicado. Se podría crear una clase llamada <code>JobeetUser</code> y hacer que <code>myUser</code> herede de ella. No obstante, existe una forma mejor de hacerlo, sobre todo si varios plugins diferentes quieren añadir métodos a la clase.</p>

<p>Los objetos internos de Symfony notifican durante su tiempo de vida diferentes eventos que podemos <em>escuchar</em>. En nuestro caso, queremos <em>escuchar</em> el evento <code>user.method_not_found</code>, que se notifica cuando se invoca un método que no existe en el objeto <code>sfUser</code>.</p>

<p>Cuando se inicializa Symfony, también se inicializan todos los plugins que tienen una clase de configuración:</p>

<div class="code php">
<pre class="php"><span class="co1">// plugins/sfJobeetPlugin/config/sfJobeetPluginConfiguration.class.php</span>
<span class="kw2">class</span> sfJobeetPluginConfiguration <span class="kw2">extends</span> sfPluginConfiguration
<span class="br0">&#123;</span>
  <span class="kw2">public</span> <span class="kw2">function</span> initialize<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">dispatcher</span><span class="sy0">-&gt;</span><span class="me1">connect</span><span class="br0">&#40;</span><span class="st_h">'user.method_not_found'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'JobeetUser'</span><span class="sy0">,</span> <span class="st_h">'methodNotFound'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Las notificaciones de los eventos se gestionan mediante el objeto <a href="http://www.symfony-project.org/api/1_2/sfEventDispatcher">sfEventDispatcher</a>. Registrar un <em>listener</em> (es decir, un método que <em>escucha</em> eventos) es tan sencillo como realizar una llamada al método <code>connect()</code>. El método <code>connect()</code> asocia un nombre de evento con un elemento ejecutable de PHP, también llamado <em>"PHP callable"</em>.</p>

<div class="admonition note"><p><strong class="title">Nota</strong> Un <a href="http://www.php.net/manual/es/function.is-callable.php">elemento ejecutable de PHP</a> es una variable de PHP que se puede utilizar en la función <code>call_user_func()</code> y que devuelve <code>true</code> cuando se pasa a la función <code>is_callable()</code>. Si el elemento ejecutable es una función, se indica mediante una cadena de texto. Si el elemento ejecutable es el método de una clase u objeto, se indica mediante un array.</p></div>

<p>El código del ejemplo anterior hace que el objeto <code>myUser</code> invoque el método estático <code>methodNotFound()</code> de la clase <code>JobeetUser</code> cada vez que no se encuentre un método en ese objeto. Después, el método <code>methodNotFound()</code> se encarga de procesar o ignorar el método que no existe en <code>myUser</code>.</p>

<p>Elimina todos los métodos de la clase <code>myUser</code> y crea en su lugar la clase <code>JobeetUser</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// apps/frontend/lib/myUser.class.php</span>
<span class="kw2">class</span> myUser <span class="kw2">extends</span> sfBasicSecurityUser
<span class="br0">&#123;</span>
<span class="br0">&#125;</span></pre>
</div>

<div class="code php">
<pre class="php"><span class="co1">// plugins/sfJobeetPlugin/lib/JobeetUser.class.php</span>
<span class="kw2">class</span> JobeetUser
<span class="br0">&#123;</span>
  static <span class="kw2">public</span> <span class="kw2">function</span> methodNotFound<span class="br0">&#40;</span>sfEvent <span class="re0">$event</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">method_exists</span><span class="br0">&#40;</span><span class="st_h">'JobeetUser'</span><span class="sy0">,</span> <span class="re0">$event</span><span class="br0">&#91;</span><span class="st_h">'method'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="re0">$event</span><span class="sy0">-&gt;</span><span class="me1">setReturnValue</span><span class="br0">&#40;</span><span class="kw3">call_user_func_array</span><span class="br0">&#40;</span>
        <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'JobeetUser'</span><span class="sy0">,</span> <span class="re0">$event</span><span class="br0">&#91;</span><span class="st_h">'method'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">,</span>
        <span class="kw3">array_merge</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span><span class="re0">$event</span><span class="sy0">-&gt;</span><span class="me1">getSubject</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$event</span><span class="br0">&#91;</span><span class="st_h">'arguments'</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
      <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
      <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
&nbsp;
  static <span class="kw2">public</span> <span class="kw2">function</span> isFirstRequest<span class="br0">&#40;</span>sfUser <span class="re0">$user</span><span class="sy0">,</span> <span class="re0">$boolean</span> <span class="sy0">=</span> <span class="kw4">null</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">is_null</span><span class="br0">&#40;</span><span class="re0">$boolean</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="re0">$user</span><span class="sy0">-&gt;</span><span class="me1">getAttribute</span><span class="br0">&#40;</span><span class="st_h">'first_request'</span><span class="sy0">,</span> <span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">else</span>
    <span class="br0">&#123;</span>
      <span class="re0">$user</span><span class="sy0">-&gt;</span><span class="me1">setAttribute</span><span class="br0">&#40;</span><span class="st_h">'first_request'</span><span class="sy0">,</span> <span class="re0">$boolean</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
&nbsp;
  static <span class="kw2">public</span> <span class="kw2">function</span> addJobToHistory<span class="br0">&#40;</span>sfUser <span class="re0">$user</span><span class="sy0">,</span> JobeetJob <span class="re0">$job</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="re0">$ids</span> <span class="sy0">=</span> <span class="re0">$user</span><span class="sy0">-&gt;</span><span class="me1">getAttribute</span><span class="br0">&#40;</span><span class="st_h">'job_history'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">in_array</span><span class="br0">&#40;</span><span class="re0">$job</span><span class="sy0">-&gt;</span><span class="me1">getId</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$ids</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="kw3">array_unshift</span><span class="br0">&#40;</span><span class="re0">$ids</span><span class="sy0">,</span> <span class="re0">$job</span><span class="sy0">-&gt;</span><span class="me1">getId</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
      <span class="re0">$user</span><span class="sy0">-&gt;</span><span class="me1">setAttribute</span><span class="br0">&#40;</span><span class="st_h">'job_history'</span><span class="sy0">,</span> <span class="kw3">array_slice</span><span class="br0">&#40;</span><span class="re0">$ids</span><span class="sy0">,</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
&nbsp;
  static <span class="kw2">public</span> <span class="kw2">function</span> getJobHistory<span class="br0">&#40;</span>sfUser <span class="re0">$user</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="kw1">return</span> JobeetJobPeer<span class="sy0">::</span><span class="me2">retrieveByPks</span><span class="br0">&#40;</span><span class="re0">$user</span><span class="sy0">-&gt;</span><span class="me1">getAttribute</span><span class="br0">&#40;</span><span class="st_h">'job_history'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  static <span class="kw2">public</span> <span class="kw2">function</span> resetJobHistory<span class="br0">&#40;</span>sfUser <span class="re0">$user</span><span class="br0">&#41;</span>
  <span class="br0">&#123;</span>
    <span class="re0">$user</span><span class="sy0">-&gt;</span><span class="me1">getAttributeHolder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">remove</span><span class="br0">&#40;</span><span class="st_h">'job_history'</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Cuando se invoca el método <code>methodNotFound()</code>, el encargado de notificar los eventos pasa como argumento un objeto de tipo <a href="http://www.symfony-project.org/api/1_2/sfEvent">sfEvent</a>.</p>

<p>Si el método existe en la clase <code>JobeetUser</code>, se invoca y el valor devuelto se devuelve al notificador de eventos. Si no existe el método, Symfony utiliza el siguiente <em>listener</em> registrado para ese evento y si ya no existen más <em>listeners</em>, se lanza una excepción.</p>

<p>El método <code>getSubject()</code> se puede utilizar para determinar el notificador del evento, que en este caso sería el objeto <code>myUser</code>.</p>

<p>Como siempre que creas nuevas clases, no te olvides de borrar la cache de Symfony antes de probar la aplicación o antes de ejecutar las pruebas:</p>

<div class="code cli">
<pre class="cli">$ php symfony cc</pre>
</div>

<h3 id="arquitectura_por_defecto_vs_arquitectura_de_los_plugins">20.3.8. Arquitectura por defecto vs. arquitectura de los plugins</h3>

<p>Si utilizas la arquitectura de los plugins, puedes organizar tu código de una forma completamente diferente:</p>

<div class="figure" id="figure_20_1">
    <img src="../../img/jobeet_1_4/f2001.png" alt="Diferencias entre la arquitectura tradicional y la arquitectura de los plugins" />

    <p class="caption"><strong>Figura 20.1</strong> Diferencias entre la arquitectura tradicional y la arquitectura de los plugins</p>
</div>




    <div class="navigation row">
            <a class="span4 prev" href="estructura_de_archivos_de_los_plugins.html">&larr; Anterior <span>20.2. Estructura de archivos de los plugins</span></a>
            
            <a class="span5 next" href="utilizando_los_plugins.html">Siguiente &rarr; <span>20.4. Utilizando los plugins</span></a>
        </div>
</div>

<div class="span3 side">
<h3 class="underline"><span>Compartir</span></h3>
<ul class="share">
    <li><a class="twitter" id="share_twitter" href="#" title="Compartir este artículo en Twitter">tw</a></li>
    <li><a class="facebook" id="share_facebook" href="#" title="Compartir este artículo en Facebook">fb</a></li>
    <li><a class="google" id="share_google" href="#" title="Compartir este artículo en Google+">g+</a></li>
</ul>

<script type="text/javascript">
var title    = 'El plugin Jobeet (El tutorial Jobeet%29';
var page_url = encodeURIComponent(window.location);
var options  = 'menubar=no,toolbar=no,resizable=yes,scrollbars=no,width=640,height=350';
var services = {
    share_twitter:  'https://twitter.com/share?text=' + title + '&lang=es&hashtags=librosweb',
    share_facebook: 'http://www.facebook.com/sharer.php?u=' + page_url + '&t=' + title,
    share_google:   'https://plus.google.com/share?url=' + page_url + '&hl=es'
};

for (var id in services) { // don't use services.keys() for compatibility reasons
    if (services.hasOwnProperty(id)) {
        document.getElementById(id).href = services[id];
        document.getElementById(id).onclick = function(a) {
            a = a || window.event;
            a = a.target || a.srcElement;
            _gaq.push(['_trackEvent', 'share', a.id.substr(6), 'El tutorial Jobeet : El plugin Jobeet']);
            window.open(services[a.id], a.title, options);

            return false;
        };
    }
}
</script>

<h3 class="underline"><span>Indice de contenidos</span></h3>
<ul class="toc">
    <li class="level-1">
        <span>1</span> <a href="../capitulo_1.html"> Comenzando el proyecto</a>
    </li>
    <li class="level-1">
        <span>2</span> <a href="../capitulo_2.html"> El proyecto</a>
    </li>
    <li class="level-1">
        <span>3</span> <a href="../capitulo_3.html"> El modelo de datos</a>
    </li>
    <li class="level-1">
        <span>4</span> <a href="../capitulo_4.html"> El controlador y la vista</a>
    </li>
    <li class="level-1">
        <span>5</span> <a href="../capitulo_5.html"> El sistema de enrutamiento</a>
    </li>
    <li class="level-1">
        <span>6</span> <a href="../capitulo_6.html"> Profundizando en el modelo</a>
    </li>
    <li class="level-1">
        <span>7</span> <a href="../capitulo_7.html"> Trabajando con la página de cada categoría</a>
    </li>
    <li class="level-1">
        <span>8</span> <a href="../capitulo_8.html"> Pruebas unitarias</a>
    </li>
    <li class="level-1">
        <span>9</span> <a href="../capitulo_9.html"> Pruebas funcionales</a>
    </li>
    <li class="level-1">
        <span>10</span> <a href="../capitulo_10.html"> Los formularios</a>
    </li>
    <li class="level-1">
        <span>11</span> <a href="../capitulo_11.html"> Probando los formularios</a>
    </li>
    <li class="level-1">
        <span>12</span> <a href="../capitulo_12.html"> El generador de la parte de administración</a>
    </li>
    <li class="level-1">
        <span>13</span> <a href="../capitulo_13.html"> El usuario</a>
    </li>
    <li class="level-1">
        <span>14</span> <a href="../capitulo_14.html"> El día de descanso</a>
    </li>
    <li class="level-1">
        <span>15</span> <a href="../capitulo_15.html"> Canales Atom</a>
    </li>
    <li class="level-1">
        <span>16</span> <a href="../capitulo_16.html"> Servicios web</a>
    </li>
    <li class="level-1">
        <span>17</span> <a href="../capitulo_17.html"> El buscador</a>
    </li>
    <li class="level-1">
        <span>18</span> <a href="../capitulo_18.html"> AJAX</a>
    </li>
    <li class="level-1">
        <span>19</span> <a href="../capitulo_19.html"> Internacionalización y localización</a>
    </li>
    <li class="level-1 ">
        <a href="../capitulo_20.html">
            <span>Capítulo 20.</span> Plugins
        </a>
    </li>
    <li class="level-2 ">
        <a href="plugins.html">
            <span>20.1.</span> Plugins
        </a>
    </li>
    <li class="level-2 ">
        <a href="estructura_de_archivos_de_los_plugins.html">
            <span>20.2.</span> Estructura de archivos de los plugins
        </a>
    </li>
    <li class="level-2 active">
        <a href="el_plugin_jobeet.html">
            <span>20.3.</span> El plugin Jobeet
        </a>
    </li>
    <li class="level-2 ">
        <a href="utilizando_los_plugins.html">
            <span>20.4.</span> Utilizando los plugins
        </a>
    </li>
    <li class="level-2 ">
        <a href="publicando_tu_plugin.html">
            <span>20.5.</span> Publicando tu plugin
        </a>
    </li>
    <li class="level-2 ">
        <a href="nos_vemos_manana.html">
            <span>20.6.</span> Nos vemos mañana
        </a>
    </li>
    <li class="level-1">
        <span>21</span> <a href="../capitulo_21.html"> El día del diseño</a>
    </li>
    <li class="level-1">
        <span>22</span> <a href="../capitulo_22.html"> La cache</a>
    </li>
    <li class="level-1">
        <span>23</span> <a href="../capitulo_23.html"> Pasando a producción</a>
    </li>
    <li class="level-1">
        <span>24</span> <a href="../capitulo_24.html"> Un repaso a Symfony</a>
    </li>
</ul>
</div>
        </div></div>
        <div id="footer" class="row">
            <span class="span6">&copy; 2013 LibrosWeb.es 
            <a href="../../contacto/index.html">Contacto</a></span>
            <span class="span6 version">2.340 días online</span>
        </div>
    </div>
    </body>
</html>

<!-- Localized -->